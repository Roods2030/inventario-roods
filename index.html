<!doctype html>
<html lang="es" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario Roods</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&amp;display=swap"
        rel="stylesheet">
    <script src="/_sdk/element_sdk.js"></script>
    <script src="/_sdk/data_sdk.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            box-sizing: border-box;
            font-family: 'DM Sans', sans-serif;
        }

        html,
        body,
        #app-container {
            height: 100%;
        }

        #app-container {
            overflow-y: auto;
        }

        .section-card {
            transition: all 0.3s ease;
        }

        .section-card:hover {
            transform: translateY(-2px);
        }

        .input-field {
            transition: all 0.2s ease;
        }

        .input-field:focus {
            transform: scale(1.02);
        }

        .provider-header {
            position: relative;
            overflow: hidden;
        }

        .provider-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-in {
            animation: fadeIn 0.4s ease forwards;
        }

        .download-btn,
        .settings-btn {
            transition: all 0.3s ease;
        }

        .download-btn:hover,
        .settings-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
        }

        .settings-btn:hover {
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
        }

        .modal-content {
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .badge-unit {
            display: inline-block;
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid rgba(16, 185, 129, 0.4);
        }

        .provider-btn {
            transition: all 0.3s ease;
            position: relative;
        }

        .provider-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        }

        .item-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: rgba(71, 85, 105, 0.5);
            padding: 1rem;
            border-radius: 0.75rem;
            transition: all 0.2s ease;
        }

        .item-row:hover {
            background: rgba(71, 85, 105, 0.7);
        }

        .spinner-button {
            user-select: none;
            -webkit-user-select: none;
        }

        .move-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .timer-display {
            font-family: 'Courier New', monospace;
            font-size: 1.875rem;
            font-weight: bold;
        }

        @keyframes pulse-timer {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        .timer-pulse {
            animation: pulse-timer 1s infinite;
        }

        .history-card {
            transition: all 0.3s ease;
        }

        .history-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        @view-transition {
            navigation: auto;
        }

        /* Lock Screen Styles */
        #lock-screen {
            background: radial-gradient(circle at center, #0f172a 0%, #020617 100%);
        }

        .pin-dot {
            width: 12px;
            height: 12px;
            border-radius: 9999px;
            border: 2px solid rgba(148, 163, 184, 0.5);
            transition: all 0.2s ease;
        }

        .pin-dot.filled {
            background-color: #10b981;
            border-color: #10b981;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
            transform: scale(1.2);
        }

        .keypad-btn {
            width: 64px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 600;
            color: white;
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(51, 65, 85, 0.5);
            border-radius: 9999px;
            transition: all 0.1s ease;
        }

        .keypad-btn:active {
            background: rgba(16, 185, 129, 0.2);
            border-color: #10b981;
            transform: scale(0.9);
        }

        .error-shake {
            animation: shake 0.4s ease-in-out;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-10px);
            }

            75% {
                transform: translateX(10px);
            }
        }
    </style>
</head>

<body class="h-full bg-slate-900">
    <!-- Lock Screen -->
    <div id="lock-screen" class="fixed inset-0 z-[100] flex flex-col items-center justify-center p-4">
        <div class="max-w-xs w-full text-center space-y-8">
            <div class="mx-auto rounded-2xl overflow-hidden shadow-2xl mb-4" style="width: 120px;">
                <img src="logo_roods.png" alt="Roods Logo" class="w-full h-auto">
            </div>

            <div class="space-y-2">
                <h2 class="text-2xl font-bold text-white">Acceso a Inventario</h2>
                <p class="text-slate-400 text-sm">Ingresa el PIN para continuar</p>
            </div>

            <!-- PIN Display Dots -->
            <div id="pin-display" class="flex justify-center gap-4 py-4">
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
            </div>

            <!-- Keypad -->
            <div class="grid grid-cols-3 gap-4 justify-items-center">
                <button class="keypad-btn" data-key="1">1</button>
                <button class="keypad-btn" data-key="2">2</button>
                <button class="keypad-btn" data-key="3">3</button>
                <button class="keypad-btn" data-key="4">4</button>
                <button class="keypad-btn" data-key="5">5</button>
                <button class="keypad-btn" data-key="6">6</button>
                <button class="keypad-btn" data-key="7">7</button>
                <button class="keypad-btn" data-key="8">8</button>
                <button class="keypad-btn" data-key="9">9</button>
                <button class="keypad-btn opacity-0 cursor-default"> </button>
                <button class="keypad-btn" data-key="0">0</button>
                <button class="keypad-btn text-red-400 text-sm" data-key="back">‚å´</button>
            </div>

            <p id="pin-error" class="text-red-400 text-sm h-4 opacity-0 transition-opacity">PIN incorrecto</p>
        </div>
    </div>

    <div id="app-container" class="h-full w-full overflow-auto hidden">
        <!-- Generic Confirmation Modal -->
        <div id="confirmation-modal"
            class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4">
            <div class="bg-slate-800 border border-slate-700 rounded-2xl p-6 max-w-sm w-full shadow-2xl animate-in">
                <h3 id="confirm-title" class="text-xl font-bold text-white mb-2">T√≠tulo</h3>
                <p id="confirm-message" class="text-slate-300 mb-6">Mensaje de confirmaci√≥n</p>
                <div class="flex gap-3 justify-end">
                    <button id="confirm-cancel-btn"
                        class="px-4 py-2 rounded-lg text-slate-300 hover:text-white hover:bg-slate-700 transition">Cancelar</button>
                    <button id="confirm-action-btn"
                        class="px-4 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-400 text-white font-bold transition">Confirmar</button>
                </div>
            </div>
        </div>

        <!-- Pantalla de Inicio -->
        <div id="start-screen"
            class="min-h-full bg-gradient-to-br from-slate-900 via-slate-800 to-emerald-900 py-8 px-4 flex flex-col items-center justify-center">
            <div class="max-w-md w-full text-center space-y-8 animate-in">
                <!-- Logo y T√≠tulo -->
                <div class="relative space-y-4">
                    <!-- Logout Button (Top Right) -->
                    <div class="absolute -top-12 -right-4 flex items-center gap-2">
                        <button id="manual-sync-btn" class="p-2 text-slate-500 hover:text-emerald-400 transition-colors"
                            title="Sincronizar Ahora">
                            <svg id="sync-icon-svg" class="w-5 h-5" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                        </button>
                        <button id="logout-btn" class="p-2 text-slate-500 hover:text-red-400 transition-colors"
                            title="Cerrar Sesi√≥n">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                            </svg>
                        </button>
                    </div>

                    <!-- Sync Indicator -->
                    <div id="sync-indicator"
                        class="absolute -top-12 left-1/2 -translate-x-1/2 flex items-center gap-2 bg-slate-800/80 backdrop-blur px-3 py-1.5 rounded-full border border-slate-700 shadow-lg text-[10px] font-bold tracking-wider transition-all duration-500 opacity-0 transform translate-y-2">
                        <span id="sync-dot" class="w-2 h-2 rounded-full bg-slate-500 animate-pulse"></span>
                        <span id="sync-text" class="text-slate-400 font-mono">SINCRONIZANDO...</span>
                    </div>

                    <div class="mx-auto shadow-2xl rounded-2xl overflow-hidden" style="width: 200px;">
                        <img src="logo_roods.png" alt="Roods Logo" class="w-full h-auto">
                    </div>
                    <h1 class="text-4xl font-bold text-white">Inventario Roods</h1>
                    <p class="text-slate-300 text-lg">Control de existencias y compras</p>
                </div>

                <!-- Botones de Acci√≥n -->
                <div class="space-y-3">
                    <button id="start-inventory-btn"
                        class="w-full bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-400 hover:to-emerald-500 text-white font-bold py-4 px-6 rounded-xl shadow-xl transition transform hover:scale-105 active:scale-95 flex items-center justify-center gap-3">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2 1m2-1l-2-1m2 1v2.5" />
                        </svg> Iniciar Nuevo Inventario
                    </button>
                    <button id="history-btn"
                        class="w-full bg-amber-500 hover:bg-amber-400 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition inline-flex items-center justify-center gap-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg> Ver Hist√≥rico
                    </button>
                    <button id="settings-btn-start"
                        class="w-full bg-blue-500 hover:bg-blue-400 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition inline-flex items-center justify-center gap-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg> Gestionar Proveedores
                    </button>
                    <!-- Purchase Order Button -->
                    <button id="purchase-btn-start"
                        class="w-full bg-purple-600 hover:bg-purple-500 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition inline-flex items-center justify-center gap-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg> √ìrdenes de Compra
                    </button>
                </div>
            </div>
        </div>
        <!-- Pantalla de Hist√≥rico -->
        <div id="history-screen"
            class="hidden min-h-full bg-gradient-to-br from-slate-900 via-slate-800 to-amber-900 py-8 px-4">
            <div class="max-w-6xl mx-auto"><!-- Header -->
                <div class="mb-8 flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold text-white flex items-center gap-3 mb-2">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg> Hist√≥rico de Inventarios
                        </h1>
                        <p class="text-slate-400">Consulta todos tus inventarios realizados</p>
                    </div><button id="back-from-history-btn"
                        class="px-6 py-3 rounded-xl bg-slate-700 hover:bg-slate-600 text-white font-semibold transition">
                        ‚Üê Volver </button>
                </div><!-- Listado de hist√≥ricos -->
                <div id="history-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- History items will be rendered here -->
                </div><!-- Empty state -->
                <div id="history-empty" class="flex flex-col items-center justify-center py-20">
                    <svg class="w-20 h-20 text-slate-600 mb-4" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <p class="text-slate-400 text-lg">No hay inventarios guardados a√∫n</p>
                    <p class="text-slate-500 text-sm">Realiza tu primer inventario para verlo aqu√≠</p>
                </div>
            </div>
        </div><!-- Pantalla de Captura -->
        <div id="capture-screen"
            class="hidden min-h-full bg-gradient-to-br from-slate-900 via-slate-800 to-emerald-900 py-8 px-4">
            <!-- Header con Timer -->
            <div class="max-w-4xl mx-auto mb-8">
                <div class="bg-gradient-to-r from-emerald-500 to-emerald-600 rounded-2xl p-6 shadow-xl">
                    <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                        <div>
                            <h1 class="text-3xl font-bold text-white flex items-center gap-2">
                                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg> Capturando Inventario
                            </h1>
                            <p id="user-info-display" class="text-emerald-100 mt-2 text-sm">Usuario: --</p>
                            <p id="start-time-display" class="text-emerald-100 text-sm">Inicio: --:-- AM</p>
                        </div>
                        <div class="text-right">
                            <p class="text-emerald-100 text-sm mb-1">Tiempo transcurrido</p>
                            <div id="timer" class="timer-display timer-pulse text-white">
                                00:00:00
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- Form -->
            <form id="inventory-form-capture" class="max-w-4xl mx-auto space-y-6 pb-8"></form>
            <!-- Botones de Acci√≥n Flotantes -->
            <div
                class="max-w-4xl mx-auto mb-8 flex flex-col sm:flex-row gap-4 justify-center sticky bottom-0 bg-gradient-to-t from-slate-900 via-slate-900 to-transparent pt-4">
                <button type="button" id="pause-resume-btn"
                    class="inline-flex items-center justify-center gap-3 bg-blue-500 hover:bg-blue-400 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition">
                    <svg class="w-5 h-5" fill="currentColor" viewbox="0 0 24 24">
                        <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z" />
                    </svg> Pausar </button> <button type="button" id="finish-inventory-btn"
                    class="inline-flex items-center justify-center gap-3 bg-emerald-500 hover:bg-emerald-400 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg> Finalizar Inventario </button> <button type="button" id="cancel-inventory-btn"
                    class="inline-flex items-center justify-center gap-3 bg-red-500 hover:bg-red-400 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg> Cancelar </button>
            </div>
        </div><!-- Pantalla de Resumen Final -->
        <div id="summary-screen"
            class="hidden min-h-full bg-gradient-to-br from-slate-900 via-slate-800 to-emerald-900 py-8 px-4 flex flex-col items-center justify-center">
            <div class="max-w-2xl w-full space-y-6 animate-in"><!-- Checkmark animado -->
                <div class="flex justify-center">
                    <div
                        class="w-24 h-24 bg-gradient-to-br from-emerald-400 to-emerald-600 rounded-full flex items-center justify-center shadow-2xl">
                        <svg class="w-16 h-16 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                    </div>
                </div><!-- T√≠tulo -->
                <div class="text-center">
                    <h1 class="text-4xl font-bold text-white mb-2">¬°Inventario Completado!</h1>
                    <p class="text-slate-300 text-lg">Resumen de tu captura</p>
                </div><!-- Informaci√≥n de Tiempos -->
                <div class="bg-slate-800/50 backdrop-blur rounded-xl p-6 border border-slate-700 space-y-4">
                    <div class="flex items-center justify-between pb-4 border-b border-slate-600"><span
                            class="text-slate-400 flex items-center gap-2">
                            <svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg> Hora de Inicio </span> <span id="summary-start-time"
                            class="text-white font-semibold">--:-- AM</span>
                    </div>
                    <div class="flex items-center justify-between pb-4 border-b border-slate-600"><span
                            class="text-slate-400 flex items-center gap-2">
                            <svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12l2 2 4-4m7 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg> Hora de Finalizaci√≥n </span> <span id="summary-end-time"
                            class="text-white font-semibold">--:-- AM</span>
                    </div>
                    <div class="flex items-center justify-between"><span class="text-slate-400 flex items-center gap-2">
                            <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg> Duraci√≥n Total </span> <span id="summary-duration"
                            class="text-white font-semibold text-lg">00:00:00</span>
                    </div>
                </div><!-- Estad√≠sticas -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-slate-700/50 rounded-lg p-4 text-center border border-slate-600">
                        <div class="text-2xl font-bold text-emerald-400" id="total-providers">
                            0
                        </div>
                        <p class="text-slate-400 text-sm mt-2">Proveedores</p>
                    </div>
                    <div class="bg-slate-700/50 rounded-lg p-4 text-center border border-slate-600">
                        <div class="text-2xl font-bold text-blue-400" id="total-items">
                            0
                        </div>
                        <p class="text-slate-400 text-sm mt-2">Insumos</p>
                    </div>
                </div><!-- Botones de Acci√≥n -->
                <div class="space-y-3 pt-4"><button type="button" id="download-summary-btn"
                        class="w-full bg-emerald-500 hover:bg-emerald-400 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition inline-flex items-center justify-center gap-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg> Descargar Excel </button> <button type="button" id="new-inventory-btn"
                        class="w-full bg-blue-500 hover:bg-blue-400 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition inline-flex items-center justify-center gap-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg> Nuevo Inventario </button> <button type="button" id="back-to-start-btn"
                        class="w-full bg-slate-700 hover:bg-slate-600 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition">
                        Volver al Inicio </button>
                </div>
            </div>
        </div>

        <!-- Pantalla de Inicio de √ìrdenes -->
        <div id="purchase-home-screen"
            class="hidden min-h-full bg-gradient-to-br from-slate-900 via-slate-800 to-purple-900 py-8 px-4">
            <div class="max-w-6xl mx-auto">
                <div class="mb-8 flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold text-white flex items-center gap-3 mb-2">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg> √ìrdenes de Compra
                        </h1>
                        <p class="text-slate-400">Genera y gestiona tus pedidos a proveedores</p>
                    </div><button id="back-from-purchase-btn"
                        class="px-6 py-3 rounded-xl bg-slate-700 hover:bg-slate-600 text-white font-semibold transition">
                        ‚Üê Volver </button>
                </div>
                <!-- Bot√≥n Principal -->
                <button id="new-purchase-order-btn"
                    class="w-full mb-8 bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-400 hover:to-purple-500 text-white font-bold py-4 px-6 rounded-xl shadow-xl transition transform hover:scale-105 active:scale-95 flex items-center justify-center gap-3">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg> Nueva Orden de Compra
                </button>

                <!-- Historial de √ìrdenes -->
                <h2 class="text-xl font-bold text-white mb-4">√öltimas √ìrdenes Generadas</h2>
                <div id="purchase-history-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Orders will be rendered here -->
                </div>
                <div id="purchase-history-empty"
                    class="flex flex-col items-center justify-center py-10 bg-slate-800/30 rounded-xl">
                    <p class="text-slate-400">No hay √≥rdenes registradas a√∫n</p>
                </div>
            </div>
        </div>

        <!-- Pantalla de Configuraci√≥n de Orden -->
        <div id="purchase-setup-screen"
            class="hidden min-h-full bg-slate-900 py-8 px-4 flex items-center justify-center">
            <div class="max-w-md w-full bg-slate-800 rounded-2xl p-6 shadow-2xl animate-in">
                <h2 class="text-2xl font-bold text-white mb-6">Configurar Nueva Orden</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-slate-300 text-sm font-medium mb-2">Solicitante</label>
                        <input type="text" id="purchase-requester-input"
                            class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label class="block text-slate-300 text-sm font-medium mb-2">Inventario Base</label>
                        <select id="purchase-inventory-select"
                            class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <!-- Options rendered via JS -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-slate-300 text-sm font-medium mb-2">Observaciones Generales</label>
                        <textarea id="purchase-notes-input" rows="3"
                            class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                            placeholder="Ej: Entrega urgente antes del viernes..."></textarea>
                    </div>
                </div>
                <div class="mt-8 flex gap-3">
                    <button id="cancel-purchase-setup-btn"
                        class="flex-1 px-4 py-3 rounded-xl bg-slate-700 hover:bg-slate-600 text-white font-medium transition">
                        Cancelar </button>
                    <button id="generate-purchase-btn"
                        class="flex-1 px-4 py-3 rounded-xl bg-purple-600 hover:bg-purple-500 text-white font-bold transition">
                        Generar √ìrdenes </button>
                </div>
            </div>
        </div>

        <!-- Pantalla de Vista Previa de √ìrdenes -->
        <div id="purchase-preview-screen"
            class="hidden min-h-full bg-gradient-to-br from-slate-900 via-slate-800 to-purple-900 py-8 px-4">
            <div class="max-w-5xl mx-auto">
                <div class="mb-8 flex items-center justify-between">
                    <h1 class="text-2xl font-bold text-white">Vista Previa de √ìrdenes</h1>
                    <button id="close-purchase-preview-btn"
                        class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-white text-sm font-medium transition">
                        Cerrar </button>
                </div>
                <div id="purchase-orders-container" class="space-y-6">
                    <!-- Order cards per provider -->
                </div>
            </div>
        </div>

        <!-- User Name Modal - Ask for username before starting inventory -->
        <div id="user-name-modal"
            class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="modal-content bg-slate-800 rounded-2xl shadow-2xl max-w-md w-full"><!-- Modal Header -->
                <div class="bg-gradient-to-r from-emerald-500 to-emerald-600 p-6 flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-white">Informaci√≥n del Operario</h2>
                </div><!-- Modal Content -->
                <div class="p-6 space-y-4">
                    <div><label class="block text-slate-300 text-sm font-medium mb-2">¬øQui√©n realiza el
                            inventario?</label>
                        <input type="text" id="user-name-input" placeholder="Ingresa tu nombre completo"
                            class="w-full bg-slate-600 border border-slate-500 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent"
                            autocomplete="off">
                    </div>
                </div><!-- Modal Footer -->
                <div class="border-t border-slate-700 p-6 flex gap-3 justify-end bg-slate-900"><button type="button"
                        id="cancel-user-name-btn"
                        class="px-6 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-white font-medium transition">
                        Cancelar </button> <button type="button" id="confirm-user-name-btn"
                        class="px-6 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-400 text-white font-medium transition">
                        Continuar </button>
                </div>
            </div>
        </div><!-- View Inventory Detail Modal -->
        <div id="inventory-detail-modal"
            class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div
                class="modal-content bg-slate-800 rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                <!-- Modal Header -->
                <div class="bg-gradient-to-r from-amber-500 to-orange-600 p-6 flex items-center justify-between">
                    <div>
                        <h2 id="detail-modal-title" class="text-2xl font-bold text-white">Detalles del Inventario</h2>
                        <p id="detail-modal-user" class="text-amber-100 text-sm mt-1">Usuario: --</p>
                    </div><button type="button" id="close-detail-modal-btn"
                        class="text-white hover:bg-white/20 p-2 rounded-lg transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg></button>
                </div><!-- Modal Content -->
                <div class="overflow-y-auto flex-1 p-6 space-y-4"><!-- Info section -->
                    <div
                        class="bg-slate-700/50 rounded-lg p-4 grid grid-cols-2 md:grid-cols-4 gap-4 border border-slate-600">
                        <div>
                            <p class="text-slate-400 text-xs font-medium mb-1">Inicio</p>
                            <p id="detail-start-time" class="text-white font-semibold">--:-- AM</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-xs font-medium mb-1">Finalizaci√≥n</p>
                            <p id="detail-end-time" class="text-white font-semibold">--:-- AM</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-xs font-medium mb-1">Duraci√≥n</p>
                            <p id="detail-duration" class="text-white font-semibold">00:00:00</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-xs font-medium mb-1">Fecha</p>
                            <p id="detail-date" class="text-white font-semibold">--/--/--</p>
                        </div>
                    </div><!-- Data table -->
                    <div class="bg-slate-700/50 rounded-lg overflow-hidden border border-slate-600">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-600 border-b border-slate-500">
                                <tr>
                                    <th class="px-4 py-3 text-left text-slate-300 font-semibold">Proveedor</th>
                                    <th class="px-4 py-3 text-left text-slate-300 font-semibold">Producto</th>
                                    <th class="px-4 py-3 text-center text-slate-300 font-semibold">Unidad</th>
                                    <th class="px-4 py-3 text-center text-slate-300 font-semibold">Existencias</th>
                                    <th class="px-4 py-3 text-center text-slate-300 font-semibold">Compras</th>
                                </tr>
                            </thead>
                            <tbody id="detail-data-body" class="divide-y divide-slate-600">
                                <!-- Data rows will be rendered here -->
                            </tbody>
                        </table>
                    </div>
                </div><!-- Modal Footer -->
                <div class="border-t border-slate-700 p-6 flex gap-3 justify-between bg-slate-900"><button type="button"
                        id="download-detail-excel-btn"
                        class="px-6 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-400 text-white font-medium transition inline-flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg> Descargar </button> <button type="button" id="close-detail-modal-btn-footer"
                        class="px-6 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-white font-medium transition">
                        Cerrar </button>
                </div>
            </div>
        </div><!-- Settings Modal - Providers List -->
        <div id="settings-modal"
            class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div
                class="modal-content bg-slate-800 rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                <!-- Modal Header -->
                <div class="bg-gradient-to-r from-blue-500 to-indigo-600 p-6 flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-white">Gestionar Proveedores</h2><button type="button"
                        id="close-settings-btn" class="text-white hover:bg-white/20 p-2 rounded-lg transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg></button>
                </div><!-- Modal Content -->
                <div id="settings-content" class="overflow-y-auto flex-1 p-6"><!-- Providers will be rendered here -->
                </div><!-- Modal Footer -->
                <div class="border-t border-slate-700 p-6 flex gap-3 justify-between bg-slate-900">
                    <div class="flex gap-3"><button type="button" id="import-excel-btn"
                            class="px-6 py-2 rounded-lg bg-blue-500 hover:bg-blue-400 text-white font-medium transition inline-flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg> Importar Excel </button> <button type="button" id="add-provider-btn"
                            class="px-6 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-400 text-white font-medium transition">
                            + Agregar Proveedor </button>
                    </div><button type="button" id="close-settings-modal-btn"
                        class="px-6 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-white font-medium transition">
                        Cerrar </button>
                </div>
            </div>
        </div><!-- Edit Provider Modal -->
        <div id="edit-provider-modal"
            class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="modal-content bg-slate-800 rounded-2xl shadow-2xl max-w-md w-full"><!-- Modal Header -->
                <div class="bg-gradient-to-r from-blue-500 to-indigo-600 p-6 flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-white">Editar Proveedor</h2><button type="button"
                        id="close-edit-provider-btn" class="text-white hover:bg-white/20 p-2 rounded-lg transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg></button>
                </div><!-- Modal Content -->
                <div class="p-6 space-y-4">
                    <div><label class="block text-slate-300 text-sm font-medium mb-2">Nombre del Proveedor</label>
                        <input type="text" id="edit-provider-name-input" placeholder="Ej: Frutas Frescas"
                            class="w-full bg-slate-600 border border-slate-500 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div><label class="block text-slate-300 text-sm font-medium mb-2">Emoji del Proveedor</label>
                        <div class="grid grid-cols-6 gap-2"><button type="button"
                                class="edit-emoji-btn p-3 bg-slate-600 hover:bg-slate-500 rounded-lg text-2xl transition"
                                data-emoji="ü•¨">ü•¨</button> <button type="button"
                                class="edit-emoji-btn p-3 bg-slate-600 hover:bg-slate-500 rounded-lg text-2xl transition"
                                data-emoji="ü•©">ü•©</button> <button type="button"
                                class="edit-emoji-btn p-3 bg-slate-600 hover:bg-slate-500 rounded-lg text-2xl transition"
                                data-emoji="üßÄ">üßÄ</button> <button type="button"
                                class="edit-emoji-btn p-3 bg-slate-600 hover:bg-slate-500 rounded-lg text-2xl transition"
                                data-emoji="üõí">üõí</button> <button type="button"
                                class="edit-emoji-btn p-3 bg-slate-600 hover:bg-slate-500 rounded-lg text-2xl transition"
                                data-emoji="üçé">üçé</button> <button type="button"
                                class="edit-emoji-btn p-3 bg-slate-600 hover:bg-slate-500 rounded-lg text-2xl transition"
                                data-emoji="üå∂Ô∏è">üå∂Ô∏è</button> <button type="button"
                                class="edit-emoji-btn p-3 bg-slate-600 hover:bg-slate-500 rounded-lg text-2xl transition"
                                data-emoji="üçû">üçû</button> <button type="button"
                                class="edit-emoji-btn p-3 bg-slate-600 hover:bg-slate-500 rounded-lg text-2xl transition"
                                data-emoji="ü•ö">ü•ö</button> <button type="button"
                                class="edit-emoji-btn p-3 bg-slate-600 hover:bg-slate-500 rounded-lg text-2xl transition"
                                data-emoji="ü•´">ü•´</button> <button type="button"
                                class="edit-emoji-btn p-3 bg-slate-600 hover:bg-slate-500 rounded-lg text-2xl transition"
                                data-emoji="üì¶">üì¶</button> <button type="button"
                                class="edit-emoji-btn p-3 bg-slate-600 hover:bg-slate-500 rounded-lg text-2xl transition"
                                data-emoji="üöö">üöö</button> <button type="button"
                                class="edit-emoji-btn p-3 bg-slate-600 hover:bg-slate-500 rounded-lg text-2xl transition"
                                data-emoji="‚≠ê">‚≠ê</button>
                        </div><input type="hidden" id="edit-provider-emoji-input" value="ü•¨">
                    </div>
                    <div><label class="block text-slate-300 text-sm font-medium mb-2">Color del Proveedor</label>
                        <select id="edit-provider-color-input"
                            class="w-full bg-slate-600 border border-slate-500 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="from-green-500 to-emerald-600">Verde - Frutas y Verduras</option>
                            <option value="from-red-500 to-rose-600">Rojo - Carnes</option>
                            <option value="from-yellow-500 to-amber-600">Amarillo - L√°cteos</option>
                            <option value="from-blue-500 to-indigo-600">Azul - Abarrotes</option>
                            <option value="from-purple-500 to-violet-600">P√∫rpura - Bebidas</option>
                            <option value="from-pink-500 to-rose-600">Rosa - Postres</option>
                            <option value="from-orange-500 to-amber-600">Naranja - Panader√≠a</option>
                            <option value="from-cyan-500 to-blue-600">Cyan - Congelados</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-slate-300 text-sm font-medium mb-2">Nombre de Contacto</label>
                            <input type="text" id="edit-provider-contact-input" placeholder="Ej: Juan P√©rez"
                                class="w-full bg-slate-600 border border-slate-500 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-slate-300 text-sm font-medium mb-2">Tel√©fono</label>
                            <input type="tel" id="edit-provider-phone-input" placeholder="Ej: 55 1234 5678"
                                class="w-full bg-slate-600 border border-slate-500 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>
                    <div>
                        <label class="block text-slate-300 text-sm font-medium mb-2">M√©todo de Pago Preferido</label>
                        <select id="edit-provider-payment-input"
                            class="w-full bg-slate-600 border border-slate-500 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="Efectivo">Efectivo</option>
                            <option value="Transferencia">Transferencia</option>
                            <option value="Tarjeta">Tarjeta</option>
                            <option value="Link de Pago">Link de Pago</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-slate-300 text-sm font-medium mb-2">Banco</label>
                            <input type="text" id="edit-provider-bank-input" placeholder="Ej: BBVA"
                                class="w-full bg-slate-600 border border-slate-500 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-slate-300 text-sm font-medium mb-2">No. Cuenta / CLABE</label>
                            <input type="text" id="edit-provider-account-input" placeholder="0123456789"
                                class="w-full bg-slate-600 border border-slate-500 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>
                </div><!-- Modal Footer -->
                <div class="border-t border-slate-700 p-6 flex gap-3 justify-end bg-slate-900"><button type="button"
                        id="cancel-edit-provider-btn"
                        class="px-6 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-white font-medium transition">
                        Cancelar </button> <button type="button" id="save-edit-provider-btn"
                        class="px-6 py-2 rounded-lg bg-blue-500 hover:bg-blue-400 text-white font-medium transition">
                        Guardar Cambios </button>
                </div>
            </div>
        </div><!-- Import Excel Modal -->
        <div id="import-modal"
            class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="modal-content bg-slate-800 rounded-2xl shadow-2xl max-w-2xl w-full"><!-- Modal Header -->
                <div class="bg-gradient-to-r from-blue-500 to-cyan-600 p-6 flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-white">Importar Datos desde Excel</h2><button type="button"
                        id="close-import-btn" class="text-white hover:bg-white/20 p-2 rounded-lg transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg></button>
                </div><!-- Modal Content -->
                <div class="p-6 space-y-4">
                    <div class="bg-slate-700/50 rounded-lg p-4 border border-slate-600">
                        <h3 class="text-white font-semibold mb-2">Formato de archivo requerido:</h3>
                        <p class="text-slate-300 text-sm mb-3">Tu archivo Excel debe tener las siguientes columnas:</p>
                        <div class="bg-slate-600 rounded p-3 text-slate-100 text-xs font-mono space-y-1">
                            <div>
                                <strong>Columna A:</strong> Proveedor (nombre del proveedor)
                            </div>
                            <div>
                                <strong>Columna B:</strong> Producto (nombre del insumo)
                            </div>
                            <div>
                                <strong>Columna C:</strong> Unidad (kg, litro, pieza, etc.)
                            </div>
                            <div>
                                <strong>Columna D:</strong> Precio Unitario (Opcional)
                            </div>
                        </div>
                        <p class="text-slate-400 text-xs mt-3">La primera fila debe contener los encabezados.</p>
                    </div>
                    <div class="border-2 border-dashed border-slate-500 rounded-lg p-8 text-center"><input type="file"
                            id="excel-file-input" accept=".xlsx,.xls,.csv" class="hidden"> <button type="button"
                            id="file-upload-btn"
                            class="inline-flex items-center gap-3 bg-blue-500 hover:bg-blue-400 text-white font-semibold py-3 px-6 rounded-lg transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg> Seleccionar Archivo </button>
                        <p id="file-name-display" class="text-slate-400 text-sm mt-3">Ning√∫n archivo seleccionado</p>
                    </div>
                    <div id="import-preview" class="hidden space-y-3">
                        <h3 class="text-white font-semibold">Vista previa de datos:</h3>
                        <div id="preview-content" class="bg-slate-700/50 rounded-lg p-4 max-h-64 overflow-y-auto">
                            <!-- Preview will be rendered here -->
                        </div>
                    </div>
                    <div id="import-error" class="hidden bg-red-500/20 border border-red-500 rounded-lg p-4">
                        <p id="error-message" class="text-red-300 text-sm"></p>
                    </div>
                </div><!-- Modal Footer -->
                <div class="border-t border-slate-700 p-6 flex gap-3 justify-end bg-slate-900"><button type="button"
                        id="cancel-import-btn"
                        class="px-6 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-white font-medium transition">
                        Cancelar </button> <button type="button" id="confirm-import-btn" disabled
                        class="px-6 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-400 disabled:bg-slate-600 disabled:cursor-not-allowed text-white font-medium transition">
                        Importar Datos </button>
                </div>
            </div>
        </div><!-- Items Modal - Edit Items for Provider -->
        <div id="items-modal"
            class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div
                class="modal-content bg-slate-800 rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                <!-- Modal Header -->
                <div id="items-header"
                    class="bg-gradient-to-r from-green-500 to-emerald-600 p-6 flex items-center justify-between">
                    <div class="flex items-center gap-3"><span id="provider-icon" class="text-4xl"></span>
                        <h2 id="items-title" class="text-2xl font-bold text-white">Insumos</h2>
                    </div><button type="button" id="close-items-btn"
                        class="text-white hover:bg-white/20 p-2 rounded-lg transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg></button>
                </div><!-- Modal Content -->
                <div id="items-content" class="overflow-y-auto flex-1 p-6 space-y-4">
                    <!-- Items will be rendered here -->
                </div><!-- Modal Footer -->
                <div class="border-t border-slate-700 p-6 flex gap-3 justify-end bg-slate-900"><button type="button"
                        id="add-item-btn"
                        class="px-6 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-400 text-white font-medium transition">
                        + Agregar Insumo </button> <button type="button" id="close-items-modal-btn"
                        class="px-6 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-white font-medium transition">
                        Cerrar </button>
                </div>
            </div>
        </div><!-- Add Provider Modal -->
        <div id="add-provider-modal"
            class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="modal-content bg-slate-800 rounded-2xl shadow-2xl max-w-md w-full"><!-- Modal Header -->
                <div class="bg-gradient-to-r from-emerald-500 to-green-600 p-6 flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-white">Nuevo Proveedor</h2><button type="button"
                        id="close-add-provider-btn" class="text-white hover:bg-white/20 p-2 rounded-lg transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg></button>
                </div><!-- Modal Content -->
                <div class="p-6 space-y-4">
                    <div><label class="block text-slate-300 text-sm font-medium mb-2">Nombre del Proveedor</label>
                        <input type="text" id="provider-name-input" placeholder="Ej: Frutas Frescas"
                            class="w-full bg-slate-600 border border-slate-500 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent">
                    </div>
                    <div><label class="block text-slate-300 text-sm font-medium mb-2">Emoji del Proveedor</label>
                        <div class="grid grid-cols-6 gap-2"><button type="button"
                                class="emoji-btn p-3 bg-slate-600 hover:bg-slate-500 rounded-lg text-2xl transition"
                                data-emoji="ü•¨">ü•¨</button> <button type="button"
                                class="emoji-btn p-3 bg-slate-600 hover:bg-slate-500 rounded-lg text-2xl transition"
                                data-emoji="ü•©">ü•©</button> <button type="button"
                                class="emoji-btn p-3 bg-slate-600 hover:bg-slate-500 rounded-lg text-2xl transition"
                                data-emoji="üßÄ">üßÄ</button> <button type="button"
                                class="emoji-btn p-3 bg-slate-600 hover:bg-slate-500 rounded-lg text-2xl transition"
                                data-emoji="üõí">üõí</button> <button type="button"
                                class="emoji-btn p-3 bg-slate-600 hover:bg-slate-500 rounded-lg text-2xl transition"
                                data-emoji="üçé">üçé</button> <button type="button"
                                class="emoji-btn p-3 bg-slate-600 hover:bg-slate-500 rounded-lg text-2xl transition"
                                data-emoji="üå∂Ô∏è">üå∂Ô∏è</button> <button type="button"
                                class="emoji-btn p-3 bg-slate-600 hover:bg-slate-500 rounded-lg text-2xl transition"
                                data-emoji="üçû">üçû</button> <button type="button"
                                class="emoji-btn p-3 bg-slate-600 hover:bg-slate-500 rounded-lg text-2xl transition"
                                data-emoji="ü•ö">ü•ö</button> <button type="button"
                                class="emoji-btn p-3 bg-slate-600 hover:bg-slate-500 rounded-lg text-2xl transition"
                                data-emoji="ü•´">ü•´</button> <button type="button"
                                class="emoji-btn p-3 bg-slate-600 hover:bg-slate-500 rounded-lg text-2xl transition"
                                data-emoji="üì¶">üì¶</button> <button type="button"
                                class="emoji-btn p-3 bg-slate-600 hover:bg-slate-500 rounded-lg text-2xl transition"
                                data-emoji="üöö">üöö</button> <button type="button"
                                class="emoji-btn p-3 bg-slate-600 hover:bg-slate-500 rounded-lg text-2xl transition"
                                data-emoji="‚≠ê">‚≠ê</button>
                        </div><input type="hidden" id="provider-emoji-input" value="ü•¨">
                    </div>
                    <div><label class="block text-slate-300 text-sm font-medium mb-2">Color del Proveedor</label>
                        <select id="provider-color-input"
                            class="w-full bg-slate-600 border border-slate-500 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent">
                            <option value="from-green-500 to-emerald-600">Verde - Frutas y Verduras</option>
                            <option value="from-red-500 to-rose-600">Rojo - Carnes</option>
                            <option value="from-yellow-500 to-amber-600">Amarillo - L√°cteos</option>
                            <option value="from-blue-500 to-indigo-600">Azul - Abarrotes</option>
                            <option value="from-purple-500 to-violet-600">P√∫rpura - Bebidas</option>
                            <option value="from-pink-500 to-rose-600">Rosa - Postres</option>
                            <option value="from-orange-500 to-amber-600">Naranja - Panader√≠a</option>
                            <option value="from-cyan-500 to-blue-600">Cyan - Congelados</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-slate-300 text-sm font-medium mb-2">Nombre de Contacto</label>
                            <input type="text" id="provider-contact-input" placeholder="Ej: Juan P√©rez"
                                class="w-full bg-slate-600 border border-slate-500 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-slate-300 text-sm font-medium mb-2">Tel√©fono</label>
                            <input type="tel" id="provider-phone-input" placeholder="Ej: 55 1234 5678"
                                class="w-full bg-slate-600 border border-slate-500 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent">
                        </div>
                    </div>
                    <div>
                        <label class="block text-slate-300 text-sm font-medium mb-2">M√©todo de Pago Preferido</label>
                        <select id="provider-payment-input"
                            class="w-full bg-slate-600 border border-slate-500 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent">
                            <option value="Efectivo">Efectivo</option>
                            <option value="Transferencia">Transferencia</option>
                            <option value="Tarjeta">Tarjeta</option>
                            <option value="Link de Pago">Link de Pago</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-slate-300 text-sm font-medium mb-2">Banco</label>
                            <input type="text" id="provider-bank-input" placeholder="Ej: BBVA"
                                class="w-full bg-slate-600 border border-slate-500 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-slate-300 text-sm font-medium mb-2">No. Cuenta / CLABE</label>
                            <input type="text" id="provider-account-input" placeholder="0123456789"
                                class="w-full bg-slate-600 border border-slate-500 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent">
                        </div>
                    </div>
                </div><!-- Modal Footer -->
                <div class="border-t border-slate-700 p-6 flex gap-3 justify-end bg-slate-900"><button type="button"
                        id="cancel-add-provider-btn"
                        class="px-6 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-white font-medium transition">
                        Cancelar </button> <button type="button" id="save-add-provider-btn"
                        class="px-6 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-400 text-white font-medium transition">
                        Crear Proveedor </button>
                </div>
            </div>
        </div>
        <!-- Edit Order Modal -->
        <div id="edit-order-modal"
            class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div
                class="modal-content bg-slate-800 rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                <div class="bg-gradient-to-r from-purple-500 to-indigo-600 p-6 flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold text-white">Editar Orden</h2>
                        <p id="edit-order-subtitle" class="text-purple-100 text-sm">Proveedor: --</p>
                    </div>
                    <button type="button" id="close-edit-order-btn"
                        class="text-white hover:bg-white/20 p-2 rounded-lg transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div id="edit-order-content" class="overflow-y-auto flex-1 p-6 space-y-4">
                    <!-- Items -->
                </div>
                <div class="border-t border-slate-700 p-6 flex items-center justify-between bg-slate-900 gap-4">
                    <!-- Add Product UI -->
                    <div id="add-to-order-container" class="flex-1 hidden">
                        <div class="flex gap-2">
                            <select id="add-item-to-order-select"
                                class="flex-1 bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <!-- Options via JS -->
                            </select>
                            <button type="button" id="confirm-add-item-btn"
                                class="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded-lg font-bold text-sm transition">A√±adir</button>
                            <button type="button" id="cancel-add-item-btn"
                                class="bg-slate-700 hover:bg-slate-600 text-slate-400 px-3 py-2 rounded-lg transition">‚úï</button>
                        </div>
                    </div>

                    <button type="button" id="show-add-item-btn"
                        class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-purple-400 font-bold transition flex items-center gap-2 whitespace-nowrap">
                        <span>‚ûï</span> A√±adir Producto
                    </button>

                    <div class="flex gap-3">
                        <button type="button" id="cancel-edit-order-btn"
                            class="px-6 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-white font-medium transition">Cancelar</button>
                        <button type="button" id="save-edit-order-btn"
                            class="px-6 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-400 text-white font-medium transition">Guardar
                            Cambios</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Finance Modal -->
        <div id="finance-modal"
            class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div
                class="modal-content bg-slate-800 rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden flex flex-col">
                <div class="bg-gradient-to-r from-blue-600 to-cyan-600 p-6 flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold text-white">Solicitud de Pago</h2>
                        <p class="text-blue-100 text-sm">Para Finanzas</p>
                    </div>
                    <button type="button" id="close-finance-modal-btn"
                        class="text-white hover:bg-white/20 p-2 rounded-lg transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="p-6 space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">Fecha M√°xima de Pago</label>
                            <input type="date" id="finance-payment-date"
                                class="w-full bg-slate-700 text-white rounded-lg p-2 text-sm border border-slate-600 focus:outline-none focus:ring-1 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">Fecha Aprox. Recepci√≥n</label>
                            <input type="date" id="finance-delivery-date"
                                class="w-full bg-slate-700 text-white rounded-lg p-2 text-sm border border-slate-600 focus:outline-none focus:ring-1 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="bg-slate-900 p-4 rounded-lg font-mono text-sm text-slate-300 select-all"
                        id="finance-request-text">
                        <!-- Request Text -->
                    </div>
                    <p class="text-xs text-slate-500 text-center">Selecciona las fechas y copia el texto para Finanzas.
                    </p>
                </div>
                <div class="border-t border-slate-700 p-6 flex gap-3 justify-end bg-slate-900">
                    <button type="button" id="mark-requested-btn"
                        class="px-6 py-2 rounded-lg bg-yellow-600 hover:bg-yellow-500 text-white font-medium transition">Marcar
                        como Solicitado</button>
                    <button type="button" id="copy-finance-btn"
                        class="px-6 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-white font-medium transition">Copiar
                        Texto</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        // State
        let providers = [
            { name: "Frutas y Verduras", icon: "ü•¨", color: "from-green-500 to-emerald-600", items: [{ name: "Tomate", unit: "kg", lastPrice: 25 }, { name: "Cebolla", unit: "kg", lastPrice: 18 }, { name: "Lechuga", unit: "pieza", lastPrice: 12 }] },
            { name: "Carnes", icon: "ü•©", color: "from-red-500 to-rose-600", items: [{ name: "Res", unit: "kg", lastPrice: 180 }, { name: "Pollo", unit: "kg", lastPrice: 95 }] },
            { name: "L√°cteos", icon: "üßÄ", color: "from-yellow-500 to-amber-600", items: [{ name: "Leche", unit: "litro", lastPrice: 24 }, { name: "Queso", unit: "kg", lastPrice: 120 }] },
            { name: "Abarrotes", icon: "üõí", color: "from-blue-500 to-indigo-600", items: [{ name: "Arroz", unit: "kg", lastPrice: 22 }, { name: "Frijol", unit: "kg", lastPrice: 35 }] }
        ];
        let currentUserName = "";
        let inventoryStartTime = null;
        let inventoryEndTime = null;
        let timerInterval = null;
        let pausedStartTime = null;
        let pausedTime = 0;
        let isTimerRunning = false;
        let purchaseHistory = [];
        let inventoryHistory = [];
        let isAuthenticated = false;
        let currentPin = "";
        const CORRECT_PIN = "1234"; // Default PIN
        let isSyncing = false;

        const SHEETS_API_URL = 'https://script.google.com/macros/s/AKfycby6b_dDBnO5LlFAYtgG4StJfOuiy6V1j0uiYoZz2NQXWfmNT4wjYOzWBwZKBxa8-vNG/exec';

        const sheetsAPI = {
            async request(action, method = 'GET', data = null) {
                const url = new URL(SHEETS_API_URL);
                if (method === 'GET') {
                    url.searchParams.append('action', action);
                }

                const options = {
                    method: method === 'POST' ? 'POST' : 'GET',
                    mode: 'cors',
                    cache: 'no-cache',
                    redirect: 'follow'
                };

                if (method === 'POST') {
                    options.body = JSON.stringify({ action, data });
                    // Explicitly NOT setting application/json to avoid preflight
                }

                try {
                    const response = await fetch(url.toString(), options);
                    const result = await response.json();
                    if (!result.success) throw new Error(result.error);
                    return result.data;
                } catch (error) {
                    console.error('Sheets API Error:', error);
                    throw error;
                }
            },

            async getProviders() { return this.request('getProviders'); },
            async getInventories() { return this.request('getInventories'); },
            async getOrders() { return this.request('getOrders'); },
            async getAll() { return this.request('getAll'); },
            async saveProviders(data) { return this.request('saveProviders', 'POST', data); },
            async saveInventories(data) { return this.request('saveInventories', 'POST', data); },
            async saveInventory(data) { return this.request('saveInventory', 'POST', data); },
            async saveOrders(data) { return this.request('saveOrders', 'POST', data); }
        };

        function updateSyncStatus(status) {
            const indicator = document.getElementById('sync-indicator');
            const dot = document.getElementById('sync-dot');
            const text = document.getElementById('sync-text');

            indicator.style.opacity = "1";
            indicator.style.transform = "translateY(0)";

            switch (status) {
                case 'syncing':
                    dot.className = "w-2 h-2 rounded-full bg-blue-500 animate-pulse";
                    text.textContent = "SINCRONIZANDO...";
                    text.className = "text-blue-400 font-mono";
                    break;
                case 'success':
                    dot.className = "w-2 h-2 rounded-full bg-emerald-500";
                    text.textContent = "SINCRONIZADO";
                    text.className = "text-emerald-400 font-mono";
                    setTimeout(() => {
                        indicator.style.opacity = "0";
                        indicator.style.transform = "translateY(2px)";
                    }, 3000);
                    break;
                case 'error':
                    dot.className = "w-2 h-2 rounded-full bg-red-500";
                    text.textContent = "ERROR SYNC";
                    text.className = "text-red-400 font-mono";
                    break;
            }
        }

        // Helper for Smart Merge
        function mergeArrays(local, remote, key = 'id', sortBy = 'id') {
            if (!remote || remote.length === 0) return local;
            const map = new Map();
            local.forEach(item => map.set(item[key], item));
            remote.forEach(item => map.set(item[key], item));

            const merged = Array.from(map.values());
            if (sortBy === 'id') {
                return merged.sort((a, b) => (b.id || "").localeCompare(a.id || ""));
            }
            return merged;
        }

        async function loadData(isBackground = false) {
            if (isSyncing) return;
            isSyncing = true;

            if (!isBackground) {
                // Initial load from LocalStorage
                const savedProviders = localStorage.getItem('providers');
                if (savedProviders) providers = JSON.parse(savedProviders);

                const savedPurchaseHistory = localStorage.getItem('purchaseHistory');
                if (savedPurchaseHistory) purchaseHistory = JSON.parse(savedPurchaseHistory);

                const savedInventoryHistory = localStorage.getItem('inventoryHistory');
                if (savedInventoryHistory) inventoryHistory = JSON.parse(savedInventoryHistory);
            }

            const syncIcon = document.getElementById('sync-icon-svg');
            if (syncIcon) syncIcon.classList.add('animate-spin');

            try {
                updateSyncStatus('syncing');
                const remote = await sheetsAPI.getAll();

                let changed = false;

                if (remote.providers && remote.providers.length > 0) {
                    const newProviders = mergeArrays(providers, remote.providers, 'name', 'none');
                    if (JSON.stringify(providers) !== JSON.stringify(newProviders)) {
                        providers = newProviders;
                        localStorage.setItem('providers', JSON.stringify(providers));
                        changed = true;
                    }
                }

                if (remote.orders) {
                    const newOrders = mergeArrays(purchaseHistory, remote.orders, 'id', 'id');
                    if (JSON.stringify(purchaseHistory) !== JSON.stringify(newOrders)) {
                        purchaseHistory = newOrders;
                        localStorage.setItem('purchaseHistory', JSON.stringify(purchaseHistory));
                        changed = true;
                    }
                }

                if (remote.inventories) {
                    const newInventories = mergeArrays(inventoryHistory, remote.inventories, 'id', 'id');
                    if (JSON.stringify(inventoryHistory) !== JSON.stringify(newInventories)) {
                        inventoryHistory = newInventories;
                        localStorage.setItem('inventoryHistory', JSON.stringify(inventoryHistory));
                        changed = true;
                    }
                }

                if (changed && !document.getElementById('start-screen').classList.contains('hidden')) {
                    // Only re-render history if we are on the start screen
                    renderPurchaseHistory();
                    renderHistory(); // This is the inventory history function
                }

                updateSyncStatus('success');
            } catch (e) {
                updateSyncStatus('error');
                console.error("Sync failed:", e);
            } finally {
                isSyncing = false;
                if (syncIcon) syncIcon.classList.remove('animate-spin');
            }
        }

        async function saveData() {
            // Local save
            localStorage.setItem('providers', JSON.stringify(providers));
            localStorage.setItem('purchaseHistory', JSON.stringify(purchaseHistory));
            localStorage.setItem('inventoryHistory', JSON.stringify(inventoryHistory));

            // Remote sync (debounced or background)
            try {
                updateSyncStatus('syncing');
                await Promise.all([
                    sheetsAPI.saveProviders(providers),
                    sheetsAPI.saveOrders(purchaseHistory),
                    sheetsAPI.saveInventories(inventoryHistory)
                ]);
                updateSyncStatus('success');
            } catch (e) {
                updateSyncStatus('error');
            }
        }

        // Authentication Logic
        function handleKeypad(key) {
            if (key === 'back') {
                currentPin = currentPin.slice(0, -1);
            } else if (currentPin.length < 4) {
                currentPin += key;
            }

            updatePinDisplay();

            if (currentPin.length === 4) {
                verifyPin();
            }
        }

        function updatePinDisplay() {
            const dots = document.querySelectorAll('.pin-dot');
            dots.forEach((dot, i) => {
                if (i < currentPin.length) dot.classList.add('filled');
                else dot.classList.remove('filled');
            });
            document.getElementById('pin-error').classList.add('opacity-0');
        }

        async function verifyPin() {
            if (currentPin === CORRECT_PIN) {
                unlockApp();
            } else {
                const display = document.getElementById('pin-display');
                display.classList.add('error-shake');
                document.getElementById('pin-error').classList.remove('opacity-0');

                setTimeout(() => {
                    display.classList.remove('error-shake');
                    currentPin = "";
                    updatePinDisplay();
                }, 500);
            }
        }

        function unlockApp() {
            isAuthenticated = true;
            localStorage.setItem('lastAuth', Date.now());

            const lockScreen = document.getElementById('lock-screen');
            const app = document.getElementById('app-container');

            lockScreen.classList.add('opacity-0');
            lockScreen.style.transition = "opacity 0.5s ease";

            setTimeout(() => {
                lockScreen.classList.add('hidden');
                lockScreen.classList.remove('opacity-0'); // Reset for next time
                app.classList.remove('hidden');
                app.classList.add('animate-in');
            }, 500);
        }

        function logout() {
            localStorage.removeItem('lastAuth');
            isAuthenticated = false;
            currentPin = "";
            updatePinDisplay();

            const lockScreen = document.getElementById('lock-screen');
            const app = document.getElementById('app-container');

            app.classList.add('hidden');
            lockScreen.classList.remove('hidden');
            lockScreen.classList.remove('opacity-0');
        }

        function checkSession() {
            const lastAuth = localStorage.getItem('lastAuth');
            // Session expires in 12 hours
            if (lastAuth && (Date.now() - parseInt(lastAuth)) < (12 * 60 * 60 * 1000)) {
                isAuthenticated = true;
                document.getElementById('lock-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
            }
        }

        // Initialize sync on load
        window.addEventListener('DOMContentLoaded', () => {
            checkSession();
            loadData();

            // Keypad Event Listeners
            document.querySelectorAll('.keypad-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (btn.dataset.key) handleKeypad(btn.dataset.key);
                });
            });

            // Logout Event Listener
            document.getElementById('logout-btn').addEventListener('click', () => {
                showConfirm("Cerrar Sesi√≥n", "¬øQuieres bloquear la aplicaci√≥n ahora?", () => {
                    logout();
                });
            });

            // Manual Sync
            document.getElementById('manual-sync-btn').addEventListener('click', () => {
                loadData(true);
            });

            // Automatic Polling (every 60 seconds)
            setInterval(() => {
                if (isAuthenticated) loadData(true);
            }, 60000);

            // Physical keyboard support
            window.addEventListener('keydown', (e) => {
                if (document.getElementById('lock-screen').classList.contains('hidden')) return;

                if (e.key >= '0' && e.key <= '9') {
                    handleKeypad(e.key);
                } else if (e.key === 'Backspace') {
                    handleKeypad('back');
                }
            });
        });

        // Timer
        function updateTimer() {
            if (!inventoryStartTime) return;
            const now = new Date();
            const diff = now - inventoryStartTime - pausedTime;
            const hours = Math.floor(diff / 3600000);
            const minutes = Math.floor((diff % 3600000) / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);
            document.getElementById('timer').textContent =
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Navigation / Modals
        function showUserNameModal() {
            document.getElementById('user-name-input').value = "";
            document.getElementById('user-name-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('user-name-input').focus(), 100);
        }

        document.getElementById('cancel-user-name-btn').addEventListener('click', () => {
            document.getElementById('user-name-modal').classList.add('hidden');
        });

        document.getElementById('confirm-user-name-btn').addEventListener('click', () => {
            const name = document.getElementById('user-name-input').value.trim();
            if (!name) { alert("Por favor ingresa tu nombre"); return; }
            currentUserName = name;
            document.getElementById('user-name-modal').classList.add('hidden');
            startInventory();
        });

        // Inventory Flow
        function startInventory() {
            inventoryStartTime = new Date();
            pausedTime = 0;
            isTimerRunning = true;
            timerInterval = setInterval(updateTimer, 1000);

            document.getElementById('user-info-display').textContent = `Usuario: ${currentUserName}`;
            document.getElementById('start-time-display').textContent = `Inicio: ${inventoryStartTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;

            renderCaptureForm();

            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('capture-screen').classList.remove('hidden');
        }

        function renderCaptureForm() {
            const form = document.getElementById('inventory-form-capture');
            form.innerHTML = '';

            providers.forEach((provider, pIndex) => {
                const section = document.createElement('div');
                section.className = "bg-slate-800 rounded-xl overflow-hidden shadow-lg border border-slate-700 section-card";

                const header = document.createElement('div');
                header.className = `px-6 py-4 bg-gradient-to-r ${provider.color} provider-header cursor-pointer flex justify-between items-center`;
                header.innerHTML = `<h2 class="text-xl font-bold text-white flex items-center gap-3"><span class="text-2xl">${provider.icon}</span> ${provider.name}</h2> <svg class="w-5 h-5 text-white transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>`;

                const content = document.createElement('div');
                content.className = "p-6 space-y-4";

                if (provider.items.length === 0) {
                    content.innerHTML = `<p class="text-slate-500 text-center italic">No hay insumos registrados</p>`;
                } else {
                    provider.items.forEach((item, iIndex) => {
                        const row = document.createElement('div');
                        row.className = "grid grid-cols-12 gap-4 items-center border-b border-slate-700 pb-4 last:border-0 last:pb-0 item-capture-row";
                        row.innerHTML = `
                            <div class="col-span-12 md:col-span-4">
                                <p class="text-slate-200 font-medium">${item.name}</p>
                                <span class="badge-unit">${item.unit}</span>
                            </div>
                            <div class="col-span-4 md:col-span-3">
                                <label class="block text-xs text-slate-400 mb-1">Existencia</label>
                                <input type="number" step="any" min="0" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white text-center focus:ring-2 focus:ring-emerald-500 input-field inventory-input" data-provider="${pIndex}" data-item="${iIndex}" placeholder="0">
                            </div>
                            <div class="col-span-4 md:col-span-3">
                                <label class="block text-xs text-slate-400 mb-1">Compra</label>
                                <input type="number" step="any" min="0" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white text-center focus:ring-2 focus:ring-blue-500 input-field purchase-input" data-provider="${pIndex}" data-item="${iIndex}" placeholder="0">
                            </div>
                            <div class="col-span-4 md:col-span-2">
                                <label class="block text-xs text-slate-400 mb-1">Estado</label>
                                <button type="button" class="w-full h-[42px] flex items-center justify-center bg-slate-700 hover:bg-slate-600 text-slate-300 rounded-lg transition-all sufficient-btn" 
                                    data-provider="${pIndex}" data-item="${iIndex}" title="Marcar como Suficiente">
                                    <span class="text-lg opacity-20 sufficient-icon">‚úÖ</span>
                                </button>
                            </div>
                        `;
                        content.appendChild(row);

                        // Toggle Sufficient Logic
                        const btn = row.querySelector('.sufficient-btn');
                        btn.onclick = () => {
                            const isSufficient = btn.getAttribute('data-sufficient') === 'true';
                            const invInput = row.querySelector('.inventory-input');
                            const purInput = row.querySelector('.purchase-input');
                            const icon = btn.querySelector('.sufficient-icon');

                            if (!isSufficient) {
                                btn.setAttribute('data-sufficient', 'true');
                                btn.classList.remove('bg-slate-700', 'text-slate-300');
                                btn.classList.add('bg-emerald-500/20', 'text-emerald-400', 'ring-1', 'ring-emerald-500/50');
                                icon.classList.remove('opacity-20');
                                icon.classList.add('opacity-100');
                                invInput.value = "";
                                purInput.value = "";
                                invInput.disabled = true;
                                purInput.disabled = true;
                                invInput.classList.add('opacity-30');
                                purInput.classList.add('opacity-30');
                                row.classList.add('bg-emerald-500/5');
                            } else {
                                btn.setAttribute('data-sufficient', 'false');
                                btn.classList.add('bg-slate-700', 'text-slate-300');
                                btn.classList.remove('bg-emerald-500/20', 'text-emerald-400', 'ring-1', 'ring-emerald-500/50');
                                icon.classList.add('opacity-20');
                                icon.classList.remove('opacity-100');
                                invInput.disabled = false;
                                purInput.disabled = false;
                                invInput.classList.remove('opacity-30');
                                purInput.classList.remove('opacity-30');
                                row.classList.remove('bg-emerald-500/5');
                            }
                        };
                    });
                }

                header.addEventListener('click', () => {
                    content.classList.toggle('hidden');
                    header.querySelector('svg').classList.toggle('rotate-180');
                });

                section.appendChild(header);
                section.appendChild(content);
                form.appendChild(section);
            });
        }

        // Finish Inventory
        document.getElementById('finish-inventory-btn').addEventListener('click', () => {
            showConfirm("Finalizar Inventario", "¬øEst√°s seguro de finalizar el inventario?", () => {
                finishInventory();
            });
        });

        // Cancel Inventory
        document.getElementById('cancel-inventory-btn').addEventListener('click', () => {
            showConfirm("Cancelar Inventario", "¬øEst√°s seguro de cancelar? Se perder√°n los datos.", () => {
                clearInterval(timerInterval);
                isTimerRunning = false;
                document.getElementById('capture-screen').classList.add('hidden');
                document.getElementById('start-screen').classList.remove('hidden');
            });
        });

        // Pause/Resume
        document.getElementById('pause-resume-btn').addEventListener('click', () => {
            if (isTimerRunning) {
                isTimerRunning = false;
                clearInterval(timerInterval);
                pausedStartTime = new Date();
                document.getElementById('pause-resume-btn').innerHTML = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg> Reanudar`;
            } else {
                isTimerRunning = true;
                if (pausedStartTime) pausedTime += (new Date() - pausedStartTime);
                pausedStartTime = null;
                timerInterval = setInterval(updateTimer, 1000);
                document.getElementById('pause-resume-btn').innerHTML = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/></svg> Pausar`;
            }
        });

        function finishInventory() {
            clearInterval(timerInterval);
            inventoryEndTime = new Date();
            isTimerRunning = false;

            const inventoryData = [];

            // Collect Data
            document.querySelectorAll('.inventory-input').forEach(input => {
                const pIndex = input.dataset.provider;
                const iIndex = input.dataset.item;
                const row = input.closest('.item-capture-row');
                const sufficientBtn = row.querySelector('.sufficient-btn');
                const isSufficient = sufficientBtn.getAttribute('data-sufficient') === 'true';

                const quantity = isSufficient ? "Suficiente" : (input.value || "0");
                const purchaseInput = row.querySelector('.purchase-input');
                const purchase = isSufficient ? "0" : (purchaseInput ? (purchaseInput.value || "0") : "0");

                inventoryData.push({
                    provider: providers[pIndex].name,
                    item: providers[pIndex].items[iIndex].name,
                    unit: providers[pIndex].items[iIndex].unit,
                    quantity: quantity,
                    purchase: purchase,
                    isSufficient: isSufficient
                });
            });

            const record = {
                id: `inv_${Date.now()}`,
                date: inventoryStartTime.toLocaleDateString(),
                startTime: inventoryStartTime.toLocaleTimeString(),
                endTime: inventoryEndTime.toLocaleTimeString(),
                duration: document.getElementById('timer').textContent,
                userName: currentUserName,
                data: inventoryData
            };

            // Save info to History
            const history = JSON.parse(localStorage.getItem('inventoryHistory') || '[]');
            history.unshift(record);
            localStorage.setItem('inventoryHistory', JSON.stringify(history));

            showSummary(record);
        }

        function showSummary(record) {
            document.getElementById('capture-screen').classList.add('hidden');
            document.getElementById('summary-screen').classList.remove('hidden');

            document.getElementById('summary-start-time').textContent = record.startTime;
            document.getElementById('summary-end-time').textContent = record.endTime;
            document.getElementById('summary-duration').textContent = record.duration;

            const providersCount = new Set(record.data.map(d => d.provider)).size;
            document.getElementById('total-providers').textContent = providersCount;
            document.getElementById('total-items').textContent = record.data.length;

            // Setup Download Button
            document.getElementById('download-summary-btn').onclick = () => downloadExcel(record);
        }

        function downloadExcel(record) {
            const wb = XLSX.utils.book_new();

            // Format Data for Excel
            const excelData = record.data.map(d => ({
                "Proveedor": d.provider,
                "Insumo": d.item,
                "Unidad": d.unit,
                "Existencia": d.isSufficient ? "Suficiente" : parseFloat(d.quantity),
                "A Comprar": parseFloat(d.purchase)
            }));

            const ws = XLSX.utils.json_to_sheet(excelData);

            // Add Header Info
            XLSX.utils.sheet_add_aoa(ws, [
                [`Inventario Roods`],
                [`Fecha: ${record.date}`],
                [`Responsable: ${record.userName}`],
                [`Duraci√≥n: ${record.duration}`],
                []
            ], { origin: "A1" });

            XLSX.utils.book_append_sheet(wb, ws, "Inventario");
            XLSX.writeFile(wb, `Inventario_${record.date.replace(/\//g, '-')}_${record.userName}.xlsx`);
        }

        // History
        document.getElementById('history-btn').addEventListener('click', () => {
            renderHistory();
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('history-screen').classList.remove('hidden');
        });

        document.getElementById('back-from-history-btn').addEventListener('click', () => {
            document.getElementById('history-screen').classList.add('hidden');
            document.getElementById('start-screen').classList.remove('hidden');
        });

        function renderHistory() {
            const history = JSON.parse(localStorage.getItem('inventoryHistory') || '[]');
            const list = document.getElementById('history-list');
            const empty = document.getElementById('history-empty');

            list.innerHTML = '';
            if (history.length === 0) {
                list.classList.add('hidden');
                empty.classList.remove('hidden');
                return;
            }

            list.classList.remove('hidden');
            empty.classList.add('hidden');

            history.forEach(rec => {
                const card = document.createElement('div');
                card.className = "bg-slate-800 p-6 rounded-xl shadow-lg border border-slate-700 hover:border-emerald-500 history-card cursor-pointer";
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                           <p class="font-bold text-white text-lg">${rec.date}</p>
                           <p class="text-slate-400 text-sm">${rec.userName}</p>
                        </div>
                        <span class="bg-emerald-500/10 text-emerald-400 text-xs px-2 py-1 rounded border border-emerald-500/20">Finalizado</span>
                    </div>
                    <div class="flex justify-between text-slate-400 text-sm">
                        <span>${rec.duration} hrs</span>
                        <span>${rec.data.length} items</span>
                    </div>
                `;
                card.onclick = () => showDetail(rec);
                list.appendChild(card);
            });
        }

        function showDetail(record) {
            document.getElementById('detail-modal-title').textContent = `Inventario ${record.date}`;
            document.getElementById('detail-modal-user').textContent = `Usuario: ${record.userName}`;
            document.getElementById('detail-start-time').textContent = record.startTime;
            document.getElementById('detail-end-time').textContent = record.endTime;
            document.getElementById('detail-duration').textContent = record.duration;
            document.getElementById('detail-date').textContent = record.date;

            const tbody = document.getElementById('detail-data-body');
            tbody.innerHTML = '';

            record.data.forEach(d => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-4 py-3 text-slate-300">${d.provider}</td>
                    <td class="px-4 py-3 text-white font-medium">${d.item}</td>
                    <td class="px-4 py-3 text-center"><span class="badge-unit">${d.unit}</span></td>
                    <td class="px-4 py-3 text-center text-emerald-400 font-bold">${d.quantity}</td>
                    <td class="px-4 py-3 text-center text-blue-400 font-bold">${d.purchase}</td>
                 `;
                tbody.appendChild(tr);
            });

            document.getElementById('download-detail-excel-btn').onclick = () => downloadExcel(record);
            document.getElementById('inventory-detail-modal').classList.remove('hidden');
        }

        document.getElementById('close-detail-modal-btn').onclick = () => document.getElementById('inventory-detail-modal').classList.add('hidden');
        document.getElementById('close-detail-modal-btn-footer').onclick = () => document.getElementById('inventory-detail-modal').classList.add('hidden');

        // Navigation Back logic
        document.getElementById('new-inventory-btn').onclick = () => {
            document.getElementById('summary-screen').classList.add('hidden');
            showUserNameModal();
        };
        document.getElementById('back-to-start-btn').onclick = () => {
            document.getElementById('summary-screen').classList.add('hidden');
            document.getElementById('start-screen').classList.remove('hidden');
        };

        // Settings & Modals (Simplified for restoration, relying on IDs)
        document.getElementById('settings-btn-start').onclick = () => {
            renderProvidersSettings();
            document.getElementById('settings-modal').classList.remove('hidden');
        };
        document.getElementById('close-settings-btn').onclick = () => document.getElementById('settings-modal').classList.add('hidden');
        document.getElementById('close-settings-modal-btn').onclick = () => document.getElementById('settings-modal').classList.add('hidden');

        function renderProvidersSettings() {
            const content = document.getElementById('settings-content');
            content.innerHTML = '';
            const list = document.createElement('div');
            list.className = "space-y-4";

            providers.forEach((p, index) => {
                const item = document.createElement('div');
                item.className = `bg-gradient-to-r ${p.color} p-4 rounded-xl text-white shadow-lg flex items-center justify-between group`;
                item.innerHTML = `
                    <div class="flex items-center gap-4 flex-1">
                        <span class="text-3xl">${p.icon}</span>
                        <div>
                            <h3 class="font-bold text-lg leading-tight">${p.name}</h3>
                            <p class="text-xs opacity-90">${p.items.length} insumos</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                         <button class="p-2 bg-black/20 hover:bg-black/30 rounded-lg transition" onclick="moveProvider(${index}, -1)" title="Subir">
                            ‚¨ÜÔ∏è
                        </button>
                        <button class="p-2 bg-black/20 hover:bg-black/30 rounded-lg transition" onclick="moveProvider(${index}, 1)" title="Bajar">
                            ‚¨áÔ∏è
                        </button>
                        <button class="p-2 bg-black/20 hover:bg-black/30 rounded-lg transition" onclick="openEditProviderData(${index})" title="Editar Datos">
                            ‚úèÔ∏è
                        </button>
                         <button class="p-2 bg-white/20 hover:bg-white/30 rounded-lg transition" onclick="openEditProviderItems(${index})" title="Gestionar Insumos">
                            üìã Insumos
                        </button>
                         <button class="p-2 bg-red-500/80 hover:bg-red-500 rounded-lg transition" onclick="deleteProvider(${index})" title="Eliminar">
                            üóëÔ∏è
                        </button>
                    </div>
                `;
                list.appendChild(item);
            });
            content.appendChild(list);
        }

        function moveProvider(index, direction) {
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= providers.length) return;
            const temp = providers[newIndex];
            providers[newIndex] = providers[index];
            providers[index] = temp;
            saveData();
            renderProvidersSettings();
        }

        function deleteProvider(index) {
            showConfirm("Eliminar Proveedor", `¬øEliminar proveedor ${providers[index].name} y sus insumos?`, () => {
                try {
                    providers.splice(index, 1);
                    saveData();
                    // Use setTimeout to ensure UI updates after modal interaction clears
                    setTimeout(() => {
                        renderProvidersSettings();
                    }, 50);
                } catch (e) {
                    console.error("Error destroying provider:", e);
                    alert("Error al eliminar proveedor");
                }
            });
        }

        function openEditProviderData(index) {
            currentEditingProviderIndex = index;
            const p = providers[index];
            document.getElementById('edit-provider-name-input').value = p.name;
            document.getElementById('edit-provider-emoji-input').value = p.icon;
            document.getElementById('edit-provider-color-input').value = p.color;
            document.getElementById('edit-provider-contact-input').value = p.contactName || "";
            document.getElementById('edit-provider-phone-input').value = p.phone || "";
            document.getElementById('edit-provider-payment-input').value = p.paymentMethod || "Efectivo";
            document.getElementById('edit-provider-bank-input').value = p.bank || "";
            document.getElementById('edit-provider-account-input').value = p.accountNumber || "";

            // Highlight current emoji
            document.querySelectorAll('.edit-emoji-btn').forEach(btn => {
                if (btn.dataset.emoji === p.icon) btn.classList.add('bg-blue-600');
                else btn.classList.remove('bg-blue-600');
            });

            document.getElementById('settings-modal').classList.add('hidden');
            document.getElementById('edit-provider-modal').classList.remove('hidden');
        }

        // Logic for Edit Provider Modal
        document.getElementById('close-edit-provider-btn').addEventListener('click', () => {
            document.getElementById('edit-provider-modal').classList.add('hidden');
            document.getElementById('settings-modal').classList.remove('hidden');
        });
        document.getElementById('cancel-edit-provider-btn').addEventListener('click', () => {
            document.getElementById('edit-provider-modal').classList.add('hidden');
            document.getElementById('settings-modal').classList.remove('hidden');
        });

        document.querySelectorAll('.edit-emoji-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.getElementById('edit-provider-emoji-input').value = btn.dataset.emoji;
                document.querySelectorAll('.edit-emoji-btn').forEach(b => b.classList.remove('bg-blue-600'));
                btn.classList.add('bg-blue-600');
            });
        });

        document.getElementById('save-edit-provider-btn').addEventListener('click', () => {
            const name = document.getElementById('edit-provider-name-input').value.trim();
            const emoji = document.getElementById('edit-provider-emoji-input').value;
            const color = document.getElementById('edit-provider-color-input').value;

            if (!name) { alert("Nombre requerido"); return; }

            providers[currentEditingProviderIndex].name = name;
            providers[currentEditingProviderIndex].icon = emoji;
            providers[currentEditingProviderIndex].color = color;
            providers[currentEditingProviderIndex].contactName = document.getElementById('edit-provider-contact-input').value;
            providers[currentEditingProviderIndex].phone = document.getElementById('edit-provider-phone-input').value;
            providers[currentEditingProviderIndex].paymentMethod = document.getElementById('edit-provider-payment-input').value;
            providers[currentEditingProviderIndex].bank = document.getElementById('edit-provider-bank-input').value;
            providers[currentEditingProviderIndex].accountNumber = document.getElementById('edit-provider-account-input').value;

            saveData();
            document.getElementById('edit-provider-modal').classList.add('hidden');
            document.getElementById('settings-modal').classList.remove('hidden');
            renderProvidersSettings();
        });

        let currentEditingProviderIndex = -1;
        function openEditProviderItems(index) {
            currentEditingProviderIndex = index;
            const p = providers[index];
            document.getElementById('provider-icon').textContent = p.icon;
            document.getElementById('items-title').textContent = p.name;
            document.getElementById('items-header').className = `bg-gradient-to-r ${p.color} p-6 flex items-center justify-between`;

            renderItemsList();
            document.getElementById('items-modal').classList.remove('hidden');
        }

        function renderItemsList() {
            const list = document.getElementById('items-content');
            list.innerHTML = '';
            const p = providers[currentEditingProviderIndex];

            p.items.forEach((item, iIndex) => {
                const row = document.createElement('div');
                row.className = "flex items-center gap-2 bg-slate-700/50 p-3 rounded-lg group";
                row.innerHTML = `
                    <div class="flex flex-col gap-1 mr-2">
                        <button class="text-xs text-slate-400 hover:text-white" onclick="moveItem(${iIndex}, -1)">‚ñ≤</button>
                        <button class="text-xs text-slate-400 hover:text-white" onclick="moveItem(${iIndex}, 1)">‚ñº</button>
                    </div>
                    <input type="text" value="${item.name}" class="bg-transparent border-b border-slate-500 text-white focus:outline-none w-full" onchange="updateItemName(${iIndex}, this.value)">
                    <div class="flex items-center gap-1 w-24">
                        <span class="text-slate-400 text-xs">$</span>
                        <input type="number" value="${item.lastPrice || 0}" class="bg-transparent border-b border-slate-500 text-white focus:outline-none w-full text-right" onchange="updateItemPrice(${iIndex}, this.value)" placeholder="0.00">
                    </div>
                    <select class="bg-slate-600 text-xs text-white rounded p-1" onchange="updateItemUnit(${iIndex}, this.value)">
                        <option value="kg" ${item.unit == 'kg' ? 'selected' : ''}>kg</option>
                        <option value="pieza" ${item.unit == 'pieza' ? 'selected' : ''}>lz</option>
                        <option value="litro" ${item.unit == 'litro' ? 'selected' : ''}>lt</option>
                        <option value="caja" ${item.unit == 'caja' ? 'selected' : ''}>cj</option>
                        <option value="paquete" ${item.unit == 'paquete' ? 'selected' : ''}>pq</option>
                    </select>
                    <button class="text-red-400 hover:text-red-300" onclick="deleteItem(${iIndex})">üóëÔ∏è</button>
                 `;
                list.appendChild(row);
            });
        }

        window.moveItem = (index, direction) => {
            const items = providers[currentEditingProviderIndex].items;
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= items.length) return;
            const temp = items[newIndex];
            items[newIndex] = items[index];
            items[index] = temp;
            saveData();
            renderItemsList();
        };

        window.updateItemName = (i, val) => { providers[currentEditingProviderIndex].items[i].name = val; saveData(); };
        window.updateItemPrice = (i, val) => { providers[currentEditingProviderIndex].items[i].lastPrice = parseFloat(val) || 0; saveData(); };
        window.updateItemUnit = (i, val) => { providers[currentEditingProviderIndex].items[i].unit = val; saveData(); };
        window.deleteItem = (i) => {
            showConfirm("Eliminar Insumo", "¬øEst√°s seguro de eliminar este insumo?", () => {
                try {
                    providers[currentEditingProviderIndex].items.splice(i, 1);
                    saveData();
                    // Use setTimeout to ensure UI updates after modal interaction clears
                    setTimeout(() => {
                        renderItemsList();
                        renderProvidersSettings();
                    }, 50);
                } catch (e) {
                    console.error("Error deleting item:", e);
                    alert("Error al eliminar insumo");
                }
            });
        };

        document.getElementById('add-item-btn').onclick = () => {
            providers[currentEditingProviderIndex].items.push({ name: "Nuevo Item", unit: "kg" });
            saveData();
            renderItemsList();
            renderProvidersSettings();
        };

        document.getElementById('close-items-btn').onclick = () => document.getElementById('items-modal').classList.add('hidden');
        document.getElementById('close-items-modal-btn').onclick = () => document.getElementById('items-modal').classList.add('hidden');

        // PURCHASE ORDER MODULE (NEW)
        document.getElementById('purchase-btn-start').addEventListener('click', () => {
            loadData();
            renderPurchaseHistory();
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('purchase-home-screen').classList.remove('hidden');
        });

        document.getElementById('back-from-purchase-btn').addEventListener('click', () => {
            document.getElementById('start-screen').classList.remove('hidden');
            document.getElementById('purchase-home-screen').classList.add('hidden');
        });

        document.getElementById('new-purchase-order-btn').addEventListener('click', () => {
            document.getElementById('purchase-requester-input').value = currentUserName || '';
            const select = document.getElementById('purchase-inventory-select');
            select.innerHTML = '';

            const inventories = JSON.parse(localStorage.getItem('inventoryHistory') || '[]');

            if (inventories.length === 0) {
                const opt = document.createElement('option');
                opt.text = "No hay inventarios disponibles";
                select.add(opt);
                select.disabled = true;
            } else {
                select.disabled = false;
                const latestOpt = document.createElement('option');
                latestOpt.value = 'latest';
                latestOpt.text = `√öltimo Inventario (${inventories[0].date} - ${inventories[0].userName})`;
                select.add(latestOpt);

                inventories.forEach(inv => {
                    const opt = document.createElement('option');
                    opt.value = inv.id;
                    opt.text = `${inv.date} - ${inv.userName}`;
                    select.add(opt);
                });
            }

            document.getElementById('purchase-home-screen').classList.add('hidden');
            document.getElementById('purchase-setup-screen').classList.remove('hidden');
        });

        document.getElementById('cancel-purchase-setup-btn').addEventListener('click', () => {
            document.getElementById('purchase-setup-screen').classList.add('hidden');
            document.getElementById('purchase-home-screen').classList.remove('hidden');
        });

        document.getElementById('generate-purchase-btn').addEventListener('click', () => {
            const requester = document.getElementById('purchase-requester-input').value;
            const inventoryId = document.getElementById('purchase-inventory-select').value;
            const notes = document.getElementById('purchase-notes-input').value;

            if (!requester) { alert('Ingresa el solicitante'); return; }
            if (!inventoryId || document.getElementById('purchase-inventory-select').disabled) { alert('No hay inventario'); return; }

            generateAndShowOrders(requester, inventoryId, notes);
        });

        document.getElementById('close-purchase-preview-btn').addEventListener('click', () => {
            document.getElementById('purchase-preview-screen').classList.add('hidden');
            document.getElementById('purchase-home-screen').classList.remove('hidden');
            renderPurchaseHistory();
        });

        function generateAndShowOrders(requester, inventoryId, notes) {
            const inventories = JSON.parse(localStorage.getItem('inventoryHistory') || '[]');
            let sourceInventory;
            if (inventoryId === 'latest') sourceInventory = inventories[0];
            else sourceInventory = inventories.find(i => i.id === inventoryId);

            if (!sourceInventory) { alert('Error al cargar inventario'); return; }

            const itemsToBuy = sourceInventory.data.filter(i => parseFloat(i.purchase) > 0);
            if (itemsToBuy.length === 0) { alert('No hay insumos con compra > 0 en este inventario.'); return; }

            const ordersByProvider = {};
            itemsToBuy.forEach(item => {
                const pName = item.provider;

                // Lookup current price from global providers to get the latest value
                const currentProvider = providers.find(p => p.name === pName);
                if (currentProvider) {
                    const currentItem = currentProvider.items.find(i => i.name === item.item);
                    if (currentItem && currentItem.lastPrice) {
                        item.lastPrice = currentItem.lastPrice;
                    }
                }

                if (!ordersByProvider[pName]) ordersByProvider[pName] = [];
                ordersByProvider[pName].push(item);
            });

            const orderRecord = {
                id: `po_${Date.now()}`,
                date: new Date().toLocaleDateString('es-MX'),
                requester: requester,
                notes: notes,
                sourceInventoryDate: sourceInventory.date,
                orders: ordersByProvider,
                statuses: {} // Initialize statuses
            };

            purchaseHistory.unshift(orderRecord);
            saveData();
            renderPurchasePreview(orderRecord);

            document.getElementById('purchase-setup-screen').classList.add('hidden');
            document.getElementById('purchase-preview-screen').classList.remove('hidden');
        }

        let currentViewingOrder = null;

        function renderPurchasePreview(orderRecord) {
            currentViewingOrder = orderRecord;
            const container = document.getElementById('purchase-orders-container');
            container.innerHTML = '';

            Object.keys(orderRecord.orders).forEach(providerName => {
                const items = orderRecord.orders[providerName];
                const providerConfig = providers.find(p => p.name === providerName) || { color: 'from-gray-500 to-gray-600', icon: 'üì¶' };

                const card = document.createElement('div');
                card.className = 'bg-slate-800 rounded-xl overflow-hidden shadow-lg border border-slate-700';

                const itemsHtml = items.map(item => `
                    <div class="flex justify-between py-2 border-b border-slate-700 last:border-0">
                        <div class="flex flex-col">
                            <span class="text-slate-300">‚ñ™Ô∏è ${item.item}</span>
                            <span class="text-slate-500 text-xs">$${(item.lastPrice || 0).toFixed(2)} / ${item.unit}</span>
                        </div>
                        <div class="text-right">
                            <div class="text-white font-bold">${item.purchase} ${item.unit}</div>
                            <div class="text-emerald-400 text-xs font-mono">$${(item.purchase * (item.lastPrice || 0)).toFixed(2)}</div>
                        </div>
                    </div>
                `).join('');

                const status = orderRecord.statuses ? (orderRecord.statuses[providerName] || 'CREADA') : 'CREADA';
                let statusColor = 'bg-slate-600';
                if (status === 'SOLICITADO') statusColor = 'bg-yellow-600';
                if (status === 'PAGADA') statusColor = 'bg-green-600';
                if (status === 'COTIZADA') statusColor = 'bg-blue-600';

                card.innerHTML = `
                    <div class="bg-gradient-to-r ${providerConfig.color} p-4 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${providerConfig.icon}</span>
                            <div>
                                <h3 class="text-xl font-bold text-white">${providerName}</h3>
                                <span class="${statusColor} text-white text-[10px] px-2 py-0.5 rounded-full font-bold uppercase tracking-wider border border-white/20">${status}</span>
                            </div>
                        </div>
                        <div class="flex gap-2">
                             <button class="edit-order-btn bg-white/20 hover:bg-white/30 text-white p-2 rounded-lg transition" title="Editar Orden">‚úèÔ∏è</button>
                             <span class="bg-black/20 text-white px-3 py-1 rounded-full text-sm flex items-center">${items.length} items</span>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="mb-6 space-y-1 text-sm">
                            ${itemsHtml}
                            <div class="border-t border-slate-700 mt-2 pt-2 flex justify-between text-white font-bold">
                                <span>Total Estimado:</span>
                                <span>$${items.reduce((sum, item) => sum + (item.purchase * (item.lastPrice || 0)), 0).toLocaleString('es-MX', { minimumFractionDigits: 2 })}</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 gap-3">
                             <div class="grid grid-cols-3 gap-3">
                                <button class="pdf-btn bg-slate-700 hover:bg-slate-600 text-white py-2 px-4 rounded-lg flex items-center justify-center gap-2 transition text-xs">üìÑ PDF</button>
                                <button class="whatsapp-btn bg-emerald-600 hover:bg-emerald-500 text-white py-2 px-4 rounded-lg flex items-center justify-center gap-2 transition text-xs">üì± WA</button>
                                <button class="email-btn bg-blue-600 hover:bg-blue-500 text-white py-2 px-4 rounded-lg flex items-center justify-center gap-2 transition text-xs">üìß Mail</button>
                             </div>
                             ${status !== 'PAGADA' ? `<button class="finance-btn bg-indigo-600 hover:bg-indigo-500 text-white py-2 px-4 rounded-lg flex items-center justify-center gap-2 transition font-bold shadow-lg shadow-indigo-500/20">üí∏ Solicitar Pago a Finanzas</button>` : ''}
                             ${status === 'SOLICITADO' ? `<button class="paid-btn bg-green-600 hover:bg-green-500 text-white py-2 px-4 rounded-lg flex items-center justify-center gap-2 transition font-bold shadow-lg shadow-green-500/20">‚úÖ Marcar como Pagado</button>` : ''}
                        </div>
                    </div>
                `;

                card.querySelector('.edit-order-btn').onclick = () => openEditOrderModal(providerName);
                card.querySelector('.pdf-btn').onclick = () => generatePDF(providerName, items, orderRecord);
                card.querySelector('.whatsapp-btn').onclick = () => sendWhatsApp(providerName, items, orderRecord);
                card.querySelector('.email-btn').onclick = () => sendEmail(providerName, items, orderRecord);

                const financeBtn = card.querySelector('.finance-btn');
                if (financeBtn) financeBtn.onclick = () => openFinanceModal(providerName);

                const paidBtn = card.querySelector('.paid-btn');
                if (paidBtn) paidBtn.onclick = () => updateOrderStatus(providerName, 'PAGADA');

                container.appendChild(card);
            });
        }

        function renderPurchaseHistory() {
            const list = document.getElementById('purchase-history-list');
            const empty = document.getElementById('purchase-history-empty');

            list.innerHTML = '';
            if (purchaseHistory.length === 0) {
                list.style.display = 'none';
                empty.style.display = 'flex';
                return;
            }
            list.style.display = 'grid';
            empty.style.display = 'none';

            purchaseHistory.forEach(order => {
                const count = Object.keys(order.orders).length;
                const card = document.createElement('div');
                card.className = 'bg-slate-800 p-6 rounded-xl border border-slate-700 hover:border-purple-500 transition cursor-pointer';
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="font-bold text-white">Orden del ${order.date}</h3>
                        <span class="text-purple-400 text-xs bg-purple-500/10 px-2 py-1 rounded border border-purple-500/20">${count} Proveedores</span>
                    </div>
                    <p class="text-slate-400 text-sm mb-2">Solicita: ${order.requester}</p>
                `;
                card.onclick = () => {
                    renderPurchasePreview(order);
                    document.getElementById('purchase-home-screen').classList.add('hidden');
                    document.getElementById('purchase-preview-screen').classList.remove('hidden');
                };
                list.appendChild(card);
            });
        }

        async function generatePDF(providerName, items, orderData) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFillColor(34, 197, 94);
            doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.text("Inventario Roods", 20, 20);
            doc.setFontSize(16);
            doc.text("ORDEN DE COMPRA", 20, 32);

            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            doc.text(`Proveedor: ${providerName}`, 20, 50);
            doc.text(`Fecha: ${orderData.date}`, 20, 56);
            doc.text(`Solicitante: ${orderData.requester}`, 20, 62);
            if (orderData.notes) doc.text(`Notas: ${orderData.notes}`, 20, 68);

            const total = items.reduce((sum, item) => sum + (item.purchase * (item.lastPrice || 0)), 0);

            const tableBody = items.map(item => [
                item.item,
                item.purchase,
                item.unit,
                `$${(item.lastPrice || 0).toFixed(2)}`,
                `$${(item.purchase * (item.lastPrice || 0)).toFixed(2)}`
            ]);

            // Add total row
            tableBody.push([
                { content: 'TOTAL ESTIMADO', colSpan: 4, styles: { fontStyle: 'bold', halign: 'right' } },
                { content: `$${total.toLocaleString('es-MX', { minimumFractionDigits: 2 })}`, styles: { fontStyle: 'bold' } }
            ]);

            doc.autoTable({
                startY: 80,
                head: [['Producto', 'Cantidad', 'Unidad', 'P. Unit.', 'Subtotal']],
                body: tableBody,
                theme: 'striped',
                headStyles: { fillColor: [16, 185, 129] },
                columnStyles: {
                    3: { halign: 'right' },
                    4: { halign: 'right' }
                }
            });
            doc.save(`Orden_${providerName}_${orderData.date}.pdf`);
        }

        function sendWhatsApp(providerName, items, orderData) {
            const total = items.reduce((sum, item) => sum + (item.purchase * (item.lastPrice || 0)), 0);
            let message = `*ORDEN DE COMPRA - Inventario Roods*\n\n`;
            message += `üìÖ Fecha: ${orderData.date}\n`;
            message += `üë§ Solicita: ${orderData.requester}\n\n`;
            message += `*PEDIDO PARA: ${providerName}*\n\n`;
            items.forEach(item => {
                const subtotal = (item.purchase * (item.lastPrice || 0));
                message += `‚ñ™Ô∏è ${item.purchase} ${item.unit} - ${item.item} ($${(item.lastPrice || 0).toFixed(2)}/u ‚Üí $${subtotal.toFixed(2)})\n`;
            });
            message += `\nüí∞ *Total Estimado: $${total.toLocaleString('es-MX', { minimumFractionDigits: 2 })}*`;
            if (orderData.notes) message += `\n\nüìù Notas: ${orderData.notes}`;
            const encoded = encodeURIComponent(message);
            window.open(`https://wa.me/?text=${encoded}`, '_blank');
        }

        function sendEmail(providerName, items, orderData) {
            const total = items.reduce((sum, item) => sum + (item.purchase * (item.lastPrice || 0)), 0);
            let subject = `Orden de Compra - ${providerName} - $${total.toLocaleString('es-MX', { minimumFractionDigits: 2 })}`;
            let body = `Estimados,\n\nAdjunto orden de compra para ${providerName}.\n\n`;
            body += `Fecha: ${orderData.date}\nSolicitante: ${orderData.requester}\n\n`;
            body += `DETALLE DEL PEDIDO:\n`;
            items.forEach(item => {
                const subtotal = (item.purchase * (item.lastPrice || 0));
                body += `- ${item.purchase} ${item.unit} de ${item.item} | $${(item.lastPrice || 0).toFixed(2)}/u | Subtotal: $${subtotal.toFixed(2)}\n`;
            });
            body += `\nTOTAL ESTIMADO: $${total.toLocaleString('es-MX', { minimumFractionDigits: 2 })}\n`;
            if (orderData.notes) body += `\nNotas: ${orderData.notes}\n`;
            body += `\nSaludos.`;
            window.open(`mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`);
        }

        // Import Logic
        document.getElementById('import-excel-btn').addEventListener('click', () => {
            document.getElementById('settings-modal').classList.add('hidden');
            document.getElementById('import-modal').classList.remove('hidden');
            document.getElementById('import-preview').classList.add('hidden');
            document.getElementById('import-error').classList.add('hidden');
            document.getElementById('file-name-display').textContent = "Ning√∫n archivo seleccionado";
            document.getElementById('confirm-import-btn').disabled = true;
            document.getElementById('excel-file-input').value = "";
        });

        document.getElementById('close-import-btn').addEventListener('click', () => document.getElementById('import-modal').classList.add('hidden'));
        document.getElementById('cancel-import-btn').addEventListener('click', () => document.getElementById('import-modal').classList.add('hidden'));

        document.getElementById('file-upload-btn').addEventListener('click', () => document.getElementById('excel-file-input').click());

        let importedProviders = [];

        document.getElementById('excel-file-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('file-name-display').textContent = file.name;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                    if (jsonData.length < 2) throw new Error("El archivo est√° vac√≠o o no tiene formato correcto.");

                    // Process Data (Assuming Col A: Provider, B: Item, C: Unit)
                    const tempProviders = {};

                    // Skip header
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (!row[0] || !row[1]) continue;

                        const pName = row[0].toString().trim();
                        const iName = row[1].toString().trim();
                        const unit = row[2] ? row[2].toString().trim() : 'kg';
                        const price = row[3] ? parseFloat(row[3]) : 0;

                        if (!tempProviders[pName]) {
                            const existing = providers.find(p => p.name === pName);
                            tempProviders[pName] = existing ? JSON.parse(JSON.stringify(existing)) : {
                                name: pName,
                                icon: "üì¶",
                                color: "from-slate-500 to-slate-600",
                                items: []
                            };
                            // If it's new, clear items to overwrite with import, or append? Let's append unique.
                        }

                        // Check if item exists
                        const existingItemIndex = tempProviders[pName].items.findIndex(it => it.name === iName);
                        if (existingItemIndex >= 0) {
                            // Update existing
                            tempProviders[pName].items[existingItemIndex].unit = unit;
                            if (price > 0) tempProviders[pName].items[existingItemIndex].lastPrice = price;
                        } else {
                            // Add new
                            tempProviders[pName].items.push({ name: iName, unit: unit, lastPrice: price });
                        }
                    }

                    importedProviders = Object.values(tempProviders);

                    // Show Preview
                    const preview = document.getElementById('preview-content');
                    preview.innerHTML = '';
                    importedProviders.forEach(p => {
                        const div = document.createElement('div');
                        div.className = "mb-2 text-slate-300 text-xs";
                        div.innerHTML = `<strong>${p.name}</strong>: ${p.items.length} insumos nuevos/actualizados.`;
                        preview.appendChild(div);
                    });

                    document.getElementById('import-preview').classList.remove('hidden');
                    document.getElementById('import-error').classList.add('hidden');
                    document.getElementById('confirm-import-btn').disabled = false;

                } catch (err) {
                    document.getElementById('import-error').classList.remove('hidden');
                    document.getElementById('error-message').textContent = err.message;
                    document.getElementById('confirm-import-btn').disabled = true;
                }
            };
            reader.readAsArrayBuffer(file);
        });

        document.getElementById('confirm-import-btn').addEventListener('click', () => {
            // Merge imported with existing
            importedProviders.forEach(newP => {
                const index = providers.findIndex(p => p.name === newP.name);
                if (index >= 0) {
                    providers[index] = newP; // Overwrite or merge logic
                } else {
                    providers.push(newP);
                }
            });
            saveData();
            alert("Importaci√≥n exitosa");
            document.getElementById('import-modal').classList.add('hidden');
            renderProvidersSettings();
        });

        // Add Provider Logic
        document.getElementById('add-provider-btn').addEventListener('click', () => {
            document.getElementById('settings-modal').classList.add('hidden');
            document.getElementById('add-provider-modal').classList.remove('hidden');
            document.getElementById('provider-name-input').value = "";
            document.getElementById('provider-contact-input').value = "";
            document.getElementById('provider-phone-input').value = "";
            document.getElementById('provider-bank-input').value = "";
            document.getElementById('provider-account-input').value = "";
            document.getElementById('provider-emoji-input').value = "üì¶";
            document.getElementById('provider-color-input').value = "from-slate-500 to-slate-600";
            document.querySelectorAll('.emoji-btn').forEach(b => b.classList.remove('bg-emerald-600'));
        });

        document.getElementById('close-add-provider-btn').addEventListener('click', () => {
            document.getElementById('add-provider-modal').classList.add('hidden');
            document.getElementById('settings-modal').classList.remove('hidden');
        });
        document.getElementById('cancel-add-provider-btn').addEventListener('click', () => {
            document.getElementById('add-provider-modal').classList.add('hidden');
            document.getElementById('settings-modal').classList.remove('hidden');
        });

        document.querySelectorAll('.emoji-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.getElementById('provider-emoji-input').value = btn.dataset.emoji;
                document.querySelectorAll('.emoji-btn').forEach(b => b.classList.remove('bg-emerald-600'));
                btn.classList.add('bg-emerald-600');
            });
        });

        document.getElementById('save-add-provider-btn').addEventListener('click', () => {
            const name = document.getElementById('provider-name-input').value.trim();
            const emoji = document.getElementById('provider-emoji-input').value;
            const color = document.getElementById('provider-color-input').value;

            if (!name) { alert("Nombre requerido"); return; }

            providers.push({
                name: name,
                icon: emoji,
                color: color,
                items: [],
                contactName: document.getElementById('provider-contact-input').value,
                phone: document.getElementById('provider-phone-input').value,
                paymentMethod: document.getElementById('provider-payment-input').value,
                bank: document.getElementById('provider-bank-input').value,
                accountNumber: document.getElementById('provider-account-input').value
            });
            saveData();
            document.getElementById('add-provider-modal').classList.add('hidden');
            renderProvidersSettings();
            document.getElementById('settings-modal').classList.remove('hidden');
        });

        // Custom Confirmation Modal Logic
        const confirmModal = document.getElementById('confirmation-modal');
        const confirmTitle = document.getElementById('confirm-title');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmBtn = document.getElementById('confirm-action-btn');
        const cancelBtn = document.getElementById('confirm-cancel-btn');
        let currentConfirmCallback = null;

        function showConfirm(title, message, callback) {
            confirmTitle.textContent = title;
            confirmMessage.textContent = message;
            currentConfirmCallback = callback;
            confirmModal.classList.remove('hidden');
        }

        function closeConfirmModal() {
            confirmModal.classList.add('hidden');
            currentConfirmCallback = null;
        }

        confirmBtn.onclick = () => {
            if (currentConfirmCallback) currentConfirmCallback();
            closeConfirmModal();
        };

        cancelBtn.onclick = closeConfirmModal;

        // Start Inventory Button
        document.getElementById('start-inventory-btn').addEventListener('click', () => {
            showUserNameModal();
        });

        // Init
        loadData();
        // Edit Order Logic
        let currentEditingOrder = null;
        let currentEditingProvider = null;

        function openEditOrderModal(providerName) {
            currentEditingProvider = providerName;
            const items = currentViewingOrder.orders[providerName];

            document.getElementById('edit-order-subtitle').textContent = `Proveedor: ${providerName}`;
            const container = document.getElementById('edit-order-content');
            container.innerHTML = '';

            items.forEach((item, index) => {
                const row = document.createElement('div');
                row.className = "flex items-center gap-4 bg-slate-700/50 p-4 rounded-lg";
                row.innerHTML = `
                    <div class="flex-1">
                        <p class="text-white font-bold">${item.item}</p>
                        <p class="text-slate-400 text-xs">${item.unit}</p>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Cant.</label>
                        <input type="number" value="${item.purchase}" step="0.1" class="bg-slate-600 text-white rounded p-2 w-20 text-center focus:outline-none focus:ring-1 focus:ring-purple-500" onchange="updateOrderQty('${providerName}', ${index}, this.value)">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Precio</label>
                         <div class="flex items-center gap-1">
                            <span class="text-slate-400 text-xs">$</span>
                            <input type="number" value="${item.lastPrice || 0}" step="0.5" class="bg-slate-600 text-white rounded p-2 w-24 text-right focus:outline-none focus:ring-1 focus:ring-purple-500" onchange="updateOrderPrice('${providerName}', ${index}, this.value)">
                        </div>
                    </div>
                     <button class="text-red-400 hover:text-red-300 p-2" onclick="removeOrderItem('${providerName}', ${index})">üóëÔ∏è</button>
                `;
                container.appendChild(row);
            });

            // Reset Add Product UI
            document.getElementById('add-to-order-container').classList.add('hidden');
            document.getElementById('show-add-item-btn').classList.remove('hidden');

            document.getElementById('edit-order-modal').classList.remove('hidden');
        }

        document.getElementById('show-add-item-btn').onclick = () => {
            const provider = providers.find(p => p.name === currentEditingProvider);
            if (!provider) return;

            const existingItems = currentViewingOrder.orders[currentEditingProvider].map(i => i.item);
            const availableItems = provider.items.filter(i => !existingItems.includes(i.name));

            const select = document.getElementById('add-item-to-order-select');
            select.innerHTML = '';

            if (availableItems.length === 0) {
                alert("No hay m√°s productos disponibles de este proveedor.");
                return;
            }

            availableItems.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item.name;
                opt.textContent = `${item.name} (${item.unit})`;
                select.appendChild(opt);
            });

            document.getElementById('show-add-item-btn').classList.add('hidden');
            document.getElementById('add-to-order-container').classList.remove('hidden');
        };

        document.getElementById('cancel-add-item-btn').onclick = () => {
            document.getElementById('add-to-order-container').classList.add('hidden');
            document.getElementById('show-add-item-btn').classList.remove('hidden');
        };

        document.getElementById('confirm-add-item-btn').onclick = () => {
            const itemName = document.getElementById('add-item-to-order-select').value;
            if (!itemName) return;

            const provider = providers.find(p => p.name === currentEditingProvider);
            const itemConfig = provider.items.find(i => i.name === itemName);

            currentViewingOrder.orders[currentEditingProvider].push({
                provider: currentEditingProvider,
                item: itemName,
                unit: itemConfig.unit,
                quantity: "0",
                purchase: "1",
                lastPrice: itemConfig.lastPrice || 0
            });

            openEditOrderModal(currentEditingProvider);
        };

        window.updateOrderQty = (pName, index, val) => {
            currentViewingOrder.orders[pName][index].purchase = parseFloat(val) || 0;
        };

        window.updateOrderPrice = (pName, index, val) => {
            currentViewingOrder.orders[pName][index].lastPrice = parseFloat(val) || 0;
        };

        window.removeOrderItem = (pName, index) => {
            currentViewingOrder.orders[pName].splice(index, 1);
            openEditOrderModal(pName); // Re-render
        };

        document.getElementById('close-edit-order-btn').onclick = () => document.getElementById('edit-order-modal').classList.add('hidden');
        document.getElementById('cancel-edit-order-btn').onclick = () => document.getElementById('edit-order-modal').classList.add('hidden');

        document.getElementById('save-edit-order-btn').onclick = () => {
            // Save to localStorage
            const orderIndex = purchaseHistory.findIndex(o => o.id === currentViewingOrder.id);
            if (orderIndex >= 0) {
                purchaseHistory[orderIndex] = currentViewingOrder;
                saveData();
                renderPurchasePreview(currentViewingOrder);
                document.getElementById('edit-order-modal').classList.add('hidden');
            } else {
                alert("Error al guardar la orden: No encontrada en el historial.");
            }
        };
        // Finance Flow Logic
        let currentFinanceProvider = null;

        function openFinanceModal(providerName) {
            currentFinanceProvider = providerName;
            const items = currentViewingOrder.orders[providerName];
            const provider = providers.find(p => p.name === providerName);
            const total = items.reduce((sum, item) => sum + (item.purchase * (item.lastPrice || 0)), 0);

            // Set default dates (payment: +3 days, delivery: +5 days)
            const today = new Date();
            const paymentDefault = new Date(today); paymentDefault.setDate(today.getDate() + 3);
            const deliveryDefault = new Date(today); deliveryDefault.setDate(today.getDate() + 5);
            const paymentDateInput = document.getElementById('finance-payment-date');
            const deliveryDateInput = document.getElementById('finance-delivery-date');
            paymentDateInput.value = paymentDefault.toISOString().split('T')[0];
            deliveryDateInput.value = deliveryDefault.toISOString().split('T')[0];

            function updateFinanceText() {
                const payDate = paymentDateInput.value ? new Date(paymentDateInput.value + 'T12:00:00').toLocaleDateString('es-MX', { day: '2-digit', month: 'long', year: 'numeric' }) : 'Sin fecha';
                const delDate = deliveryDateInput.value ? new Date(deliveryDateInput.value + 'T12:00:00').toLocaleDateString('es-MX', { day: '2-digit', month: 'long', year: 'numeric' }) : 'Sin fecha';

                const text = `SOLICITUD DE PAGO\n` +
                    `---------------------------\n` +
                    `Proveedor: ${providerName}\n` +
                    `Solicitante: ${currentViewingOrder.user || currentViewingOrder.requester}\n` +
                    `Total a Pagar: $${total.toLocaleString('es-MX', { minimumFractionDigits: 2 })}\n\n` +
                    `FECHAS:\n` +
                    `Fecha M√°xima de Pago: ${payDate}\n` +
                    `Fecha Aprox. Recepci√≥n: ${delDate}\n\n` +
                    `DATOS BANCARIOS:\n` +
                    `Banco: ${provider.bank || 'No registrado'}\n` +
                    `Cuenta/CLABE: ${provider.accountNumber || 'No registrada'}\n` +
                    `M√©todo: ${provider.paymentMethod || 'No especificado'}\n\n` +
                    `Concepto: Pago Orden ${currentViewingOrder.id.substring(0, 8)}`;
                document.getElementById('finance-request-text').textContent = text;
            }

            updateFinanceText();
            paymentDateInput.onchange = updateFinanceText;
            deliveryDateInput.onchange = updateFinanceText;

            document.getElementById('finance-modal').classList.remove('hidden');
        }

        document.getElementById('close-finance-modal-btn').onclick = () => document.getElementById('finance-modal').classList.add('hidden');

        document.getElementById('copy-finance-btn').onclick = () => {
            const text = document.getElementById('finance-request-text').textContent;
            navigator.clipboard.writeText(text).then(() => alert("Texto copiado al portapapeles"));
        };

        document.getElementById('mark-requested-btn').onclick = () => {
            updateOrderStatus(currentFinanceProvider, 'SOLICITADO');
            document.getElementById('finance-modal').classList.add('hidden');
        };

        function updateOrderStatus(providerName, status) {
            if (!currentViewingOrder.statuses) currentViewingOrder.statuses = {};
            currentViewingOrder.statuses[providerName] = status;

            // Save
            const orderIndex = purchaseHistory.findIndex(o => o.id === currentViewingOrder.id);
            if (orderIndex >= 0) {
                purchaseHistory[orderIndex] = currentViewingOrder;
                saveData();
                renderPurchasePreview(currentViewingOrder);
            }
        }
    </script>
</body>

</html>